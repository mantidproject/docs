<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>IntegratePeaksMD v2</title>
    
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.2.0/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.2.0/css/bootstrap-theme.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '3.9.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.2.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="" href="../index.html" />
    <link rel="next" title="IntegratePeaksMDHKL v1" href="IntegratePeaksMDHKL-v1.html" />
    <link rel="prev" title="IntegratePeaksMD v1" href="IntegratePeaksMD-v1.html" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59110517-1', 'auto');
  ga('send', 'pageview');

</script>


  </head>
  <body>





  <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://www.mantidproject.org"><img src="../_static/Mantid_Logo_Transparent.png">
           </a>
        <span class="navbar-text navbar-version pull-left"><b>3.9</b></span>
      </div>

      
        <div class="collapse navbar-collapse nav-collapse">
      
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
                <li><a href="http://www.mantidproject.org">Home</a></li>
                <li><a href="http://download.mantidproject.org">Download</a></li>
                <li><a href="http://www.mantidproject.org/Documentation">Documentation</a></li>
                <li><a href="http://www.mantidproject.org/Contact">Contact Us</a></li>
            
            
              
              
            
            
            
            
          </ul>
              
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
            </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      
  <div class="section" id="integratepeaksmd-v2">
<span id="algm-integratepeaksmd"></span><span id="algm-integratepeaksmd-v2"></span><h1>IntegratePeaksMD v2<a class="headerlink" href="#integratepeaksmd-v2" title="Permalink to this headline">¶</a></h1>
<div class="figure align-right" id="index-0">
<a class="screenshot reference internal image-reference" href="../_images/IntegratePeaksMD-v2_dlg.png"><img alt="../_images/IntegratePeaksMD-v2_dlg.png" class="screenshot" src="../_images/IntegratePeaksMD-v2_dlg.png" style="width: 250px;" /></a>
<p class="caption"><strong>IntegratePeaksMD</strong> dialog.</p>
</div>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#summary" id="id1">Summary</a></li>
<li><a class="reference internal" href="#properties" id="id2">Properties</a></li>
<li><a class="reference internal" href="#description" id="id3">Description</a><ul>
<li><a class="reference internal" href="#similar-algorithms" id="id4">Similar algorithms</a></li>
<li><a class="reference internal" href="#inputs" id="id5">Inputs</a></li>
<li><a class="reference internal" href="#calculations" id="id6">Calculations</a></li>
<li><a class="reference internal" href="#background-subtraction" id="id7">Background Subtraction</a></li>
<li><a class="reference internal" href="#if-backgroundinnerradius-is-omitted" id="id8">If BackgroundInnerRadius is Omitted</a></li>
<li><a class="reference internal" href="#integrateifonedge-option" id="id9">IntegrateIfOnEdge option</a></li>
<li><a class="reference internal" href="#correctifonedge-option" id="id10">CorrectIfOnEdge option</a></li>
</ul>
</li>
<li><a class="reference internal" href="#usage" id="id11">Usage</a></li>
<li><a class="reference internal" href="#source" id="id12">Source</a></li>
</ul>
</div>
<div class="section" id="summary">
<h2><a class="toc-backref" href="#id1">Summary</a><a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>Integrate single-crystal peaks in reciprocal space, for MDEventWorkspaces.</p>
</div>
<div class="section" id="properties">
<h2><a class="toc-backref" href="#id2">Properties</a><a class="headerlink" href="#properties" title="Permalink to this headline">¶</a></h2>
<table border="1" class="docutils">
<colgroup>
<col width="5%" />
<col width="2%" />
<col width="9%" />
<col width="5%" />
<col width="79%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Direction</th>
<th class="head">Type</th>
<th class="head">Default</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>InputWorkspace</td>
<td>Input</td>
<td><a class="reference internal" href="../concepts/MDWorkspace.html#mdworkspace"><em>MDEventWorkspace</em></a></td>
<td><em>Mandatory</em></td>
<td>An input MDEventWorkspace.</td>
</tr>
<tr class="row-odd"><td>PeakRadius</td>
<td>Input</td>
<td>number</td>
<td>1</td>
<td>Fixed radius around each peak position in which to integrate (in the same units as the workspace).</td>
</tr>
<tr class="row-even"><td>BackgroundInnerRadius</td>
<td>Input</td>
<td>number</td>
<td>0</td>
<td>Inner radius to use to evaluate the background of the peak. If smaller than PeakRadius, then we assume BackgroundInnerRadius = PeakRadius.</td>
</tr>
<tr class="row-odd"><td>BackgroundOuterRadius</td>
<td>Input</td>
<td>number</td>
<td>0</td>
<td>Outer radius to use to evaluate the background of the peak. The signal density around the peak (BackgroundInnerRadius &lt; r &lt; BackgroundOuterRadius) is used to estimate the background under the peak. If smaller than PeakRadius, no background measurement is done.</td>
</tr>
<tr class="row-even"><td>PeaksWorkspace</td>
<td>Input</td>
<td>PeaksWorkspace</td>
<td><em>Mandatory</em></td>
<td>A PeaksWorkspace containing the peaks to integrate.</td>
</tr>
<tr class="row-odd"><td>OutputWorkspace</td>
<td>Output</td>
<td>PeaksWorkspace</td>
<td>&nbsp;</td>
<td>The output PeaksWorkspace will be a copy of the input PeaksWorkspace with the peaks&#8217; integrated intensities.</td>
</tr>
<tr class="row-even"><td>ReplaceIntensity</td>
<td>Input</td>
<td>boolean</td>
<td>True</td>
<td>Always replace intensity in PeaksWorkspacem (default). If false, then do not replace intensity if calculated value is 0 (used for SNSSingleCrystalReduction)</td>
</tr>
<tr class="row-odd"><td>IntegrateIfOnEdge</td>
<td>Input</td>
<td>boolean</td>
<td>True</td>
<td>Only warning if all of peak outer radius is not on detector (default). If false, do not integrate if the outer radius is not on a detector.</td>
</tr>
<tr class="row-even"><td>AdaptiveQBackground</td>
<td>Input</td>
<td>boolean</td>
<td>False</td>
<td>Default is false.   If true, BackgroundOuterRadius + AdaptiveQMultiplier * <strong>|Q|</strong> and BackgroundInnerRadius + AdaptiveQMultiplier * <strong>|Q|</strong></td>
</tr>
<tr class="row-odd"><td>Cylinder</td>
<td>Input</td>
<td>boolean</td>
<td>False</td>
<td>Default is sphere.  Use next five parameters for cylinder.</td>
</tr>
<tr class="row-even"><td>CylinderLength</td>
<td>Input</td>
<td>number</td>
<td>0</td>
<td>Length of cylinder in which to integrate (in the same units as the workspace).</td>
</tr>
<tr class="row-odd"><td>PercentBackground</td>
<td>Input</td>
<td>number</td>
<td>0</td>
<td>Percent of CylinderLength that is background (20 is 20%)</td>
</tr>
<tr class="row-even"><td>ProfileFunction</td>
<td>Input</td>
<td>string</td>
<td>Gaussian</td>
<td>Fitting function for profile that is used only with Cylinder integration. Allowed values: [&#8216;BackToBackExponential&#8217;, &#8216;Bk2BkExpConvPV&#8217;, &#8216;DeltaFunction&#8217;, &#8216;ElasticDiffRotDiscreteCircle&#8217;, &#8216;ElasticDiffSphere&#8217;, &#8216;ElasticIsoRotDiff&#8217;, &#8216;ExamplePeakFunction&#8217;, &#8216;Gaussian&#8217;, &#8216;IkedaCarpenterPV&#8217;, &#8216;Lorentzian&#8217;, &#8216;PseudoVoigt&#8217;, &#8216;Voigt&#8217;, &#8216;NoFit&#8217;]</td>
</tr>
<tr class="row-odd"><td>IntegrationOption</td>
<td>Input</td>
<td>string</td>
<td>GaussianQuadrature</td>
<td>Integration method for calculating intensity used only with Cylinder integration. Allowed values: [&#8216;Sum&#8217;, &#8216;GaussianQuadrature&#8217;]</td>
</tr>
<tr class="row-even"><td>ProfilesFile</td>
<td>Input</td>
<td>string</td>
<td>&nbsp;</td>
<td>Save (Optionally) as Isaw peaks file with profiles included. Allowed values: [&#8216;profiles&#8217;]</td>
</tr>
<tr class="row-odd"><td>AdaptiveQMultiplier</td>
<td>Input</td>
<td>number</td>
<td>0</td>
<td>PeakRadius + AdaptiveQMultiplier * <strong>|Q|</strong> so each peak has a different integration radius.  Q includes the 2*pi factor.</td>
</tr>
<tr class="row-even"><td>CorrectIfOnEdge</td>
<td>Input</td>
<td>boolean</td>
<td>False</td>
<td>Only warning if all of peak outer radius is not on detector (default). If false, correct for volume off edge for both background and intensity.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="description">
<h2><a class="toc-backref" href="#id3">Description</a><a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h2>
<p>This algorithm performs integration of single-crystal peaks within a
radius (with optional background subtraction) in reciprocal space.</p>
<div class="section" id="similar-algorithms">
<h3><a class="toc-backref" href="#id4">Similar algorithms</a><a class="headerlink" href="#similar-algorithms" title="Permalink to this headline">¶</a></h3>
<p>See <a class="reference internal" href="IntegrateEllipsoids-v1.html#algm-integrateellipsoids"><em>IntegrateEllipsoids v1</em></a> for a ways of integrating peaks from data collected in
<a class="reference external" href="http://www.mantidproject.org/EventWorkspace">EventWorkspace</a>. <a class="reference internal" href="PeakIntensityVsRadius-v1.html#algm-peakintensityvsradius"><em>PeakIntensityVsRadius v1</em></a>
is meant to help determine an appropriate value for <cite>PeakRadius</cite>.</p>
</div>
<div class="section" id="inputs">
<h3><a class="toc-backref" href="#id5">Inputs</a><a class="headerlink" href="#inputs" title="Permalink to this headline">¶</a></h3>
<p>The algorithms takes two input workspaces:</p>
<ul class="simple">
<li>A MDEventWorkspace containing the events in multi-dimensional space.
This would be the output of
<a class="reference internal" href="ConvertToDiffractionMDWorkspace-v3.html#algm-converttodiffractionmdworkspace"><em>ConvertToDiffractionMDWorkspace v3</em></a>.</li>
<li>As well as a PeaksWorkspace containing single-crystal peak locations.
This could be the output of <a class="reference internal" href="FindPeaksMD-v1.html#algm-findpeaksmd"><em>FindPeaksMD v1</em></a></li>
<li>The OutputWorkspace will contain a copy of the input PeaksWorkspace,
with the integrated intensity and error found being filled in.</li>
</ul>
</div>
<div class="section" id="calculations">
<h3><a class="toc-backref" href="#id6">Calculations</a><a class="headerlink" href="#calculations" title="Permalink to this headline">¶</a></h3>
<p>Integration is performed by summing the weights of each MDEvent within
the provided radii. Errors are also summed in quadrature.</p>
<div class="figure">
<img alt="IntegratePeaksMD_graph1.png" src="../_images/IntegratePeaksMD_graph1.png" />
<p class="caption">IntegratePeaksMD_graph1.png</p>
</div>
<ul class="simple">
<li>All the Radii are specified in <img class="math" src="../_images/math/6a26608fecb234d0fec191d304be31c0bbee508e.png" alt="\AA^{-1}" style="vertical-align: 0px"/></li>
<li>A sphere of radius <strong>PeakRadius</strong> is integrated around the center of
each peak.<ul>
<li>This gives the summed intensity <img class="math" src="../_images/math/c272b9e89f84ffeaebcc3f795fa46cfa046b21f9.png" alt="I_{peak}" style="vertical-align: -6px"/> and the summed
squared error <img class="math" src="../_images/math/4a689b8dad50e958d9f8c74133dc96225008331f.png" alt="\sigma I_{peak}^2" style="vertical-align: -8px"/>.</li>
<li>The volume of integration is <img class="math" src="../_images/math/b90288626ee4ec936b81a9102a181cf878e3a055.png" alt="V_{peak}" style="vertical-align: -6px"/>.</li>
</ul>
</li>
<li>If <strong>BackgroundOuterRadius</strong> is specified, then a shell, with radius
r where <strong>BackgroundInnerRadius</strong> &lt; r &lt; <strong>BackgroundOuterRadius</strong>, is
integrated.<ul>
<li>This gives the summed intensity <img class="math" src="../_images/math/650ddbe81286076c8c308bea0ca7b7a1943f0a41.png" alt="I_{shell}" style="vertical-align: -3px"/> and the summed
squared error <img class="math" src="../_images/math/92379564290063994c72a47b130c16fb0d4351e2.png" alt="\sigma I_{shell}^2" style="vertical-align: -5px"/>.</li>
<li>The volume of integration is <img class="math" src="../_images/math/fb950a52a95fdce4b827fca0bd49a6180cf13082.png" alt="V_{shell}" style="vertical-align: -3px"/>.</li>
<li><strong>BackgroundInnerRadius</strong> allows you to give some space between
the peak and the background area.</li>
<li>The top 1% of the background events are removed so that there are no intensity spikes near the edges.</li>
</ul>
</li>
<li><strong>AdaptiveQMultiplier</strong> can be used for the radius to vary as a function of the modulus of Q. If the AdaptiveQBackground option is set to True, the background radius also changes so each peak has a different integration radius.  Q includes the 2*pi factor.<ul>
<li>PeakRadius + AdaptiveQMultiplier * <strong>|Q|</strong></li>
<li>BackgroundOuterRadius + AdaptiveQMultiplier * <strong>|Q|</strong></li>
<li>BackgroundInnerRadius + AdaptiveQMultiplier * <strong>|Q|</strong></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="background-subtraction">
<h3><a class="toc-backref" href="#id7">Background Subtraction</a><a class="headerlink" href="#background-subtraction" title="Permalink to this headline">¶</a></h3>
<p>The background signal within PeakRadius is calculated by scaling the
background signal density in the shell to the volume of the peak:</p>
<p><img class="math" src="../_images/math/828a306b6cb299f7c044bdc42e939362c70331f7.png" alt="I_{bg} = I_{shell} \frac{V_{peak}}{V_{shell}}" style="vertical-align: -8px"/></p>
<p>with the error squared on that value:</p>
<p><img class="math" src="../_images/math/06b2319a39d42593cd7eb126c9ac7e143d8a78d5.png" alt="\sigma I_{bg}^2 = (\frac{V_{peak}}{V_{shell}})^2 \sigma I_{shell}^2" style="vertical-align: -8px"/></p>
<p>This is applied to the integrated peak intensity <img class="math" src="../_images/math/c272b9e89f84ffeaebcc3f795fa46cfa046b21f9.png" alt="I_{peak}" style="vertical-align: -6px"/> to
give the corrected intensity <img class="math" src="../_images/math/a9a1d2f90def33a064320209166b2864a0686378.png" alt="I_{corr}" style="vertical-align: -3px"/>:</p>
<p><img class="math" src="../_images/math/03c35af572c3ee53b09753f0bb01eb94d69c6d25.png" alt="I_{corr} = I_{peak} - I_{bg}" style="vertical-align: -6px"/></p>
<p>with the errors summed in quadrature:</p>
<p><img class="math" src="../_images/math/e477c24b669b123b3d0af2e0ba9b9f0eaee21609.png" alt="\sigma I_{corr}^2 = \sigma I_{peak}^2 + \sigma I_{bg}^2" style="vertical-align: -8px"/></p>
</div>
<div class="section" id="if-backgroundinnerradius-is-omitted">
<h3><a class="toc-backref" href="#id8">If BackgroundInnerRadius is Omitted</a><a class="headerlink" href="#if-backgroundinnerradius-is-omitted" title="Permalink to this headline">¶</a></h3>
<p>If BackgroundInnerRadius is left blank, then <strong>BackgroundInnerRadius</strong> =
<strong>PeakRadius</strong>, and the integration is as follows:</p>
<div class="figure">
<img alt="IntegratePeaksMD_graph2.png" src="../_images/IntegratePeaksMD_graph2.png" />
<p class="caption">IntegratePeaksMD_graph2.png</p>
</div>
</div>
<div class="section" id="integrateifonedge-option">
<h3><a class="toc-backref" href="#id9">IntegrateIfOnEdge option</a><a class="headerlink" href="#integrateifonedge-option" title="Permalink to this headline">¶</a></h3>
<p>Edges for each bank or pack of tubes of the instrument are defined by masking the edges in the PeaksWorkspace instrument.
e.g. For TOPAZ pixels 0 and 255 in both directions for the Rectangular Detector.
Q in the lab frame for every peak is calculated, call it C
For every point on the edge, the trajectory in reciprocal space is a straight line, going through:</p>
<p><img class="math" src="../_images/math/963ba96c8abaea59416fe15eac9546025a6d0628.png" alt="\vec{O}=(0,0,0)" style="vertical-align: -4px"/></p>
<p>Calculate a point at a fixed momentum, say k=1.
Q in the lab frame:</p>
<p><img class="math" src="../_images/math/2e37c347d3293b05ad8eb701cd8bab6cf2ea471d.png" alt="\vec{E}=(-k*sin(\theta)*cos(\phi),-k*sin(\theta)*sin(\phi),k-k*cos(\phi))" style="vertical-align: -4px"/></p>
<p>Normalize E to 1:</p>
<p><img class="math" src="../_images/math/9784ab4fcaaed2b02c7480fbf9bc025b9a68fe2c.png" alt="\vec{E}=\vec{E}*(1./\left|\vec{E}\right|)" style="vertical-align: -13px"/></p>
<p>The distance from C to OE is given by:</p>
<p><img class="math" src="../_images/math/5c0bf0b63893eda746efc3513c64ac1799659e96.png" alt="dv=\vec{C}-\vec{E}*(\vec{C} \cdot \vec{E})" style="vertical-align: -4px"/></p>
<p>If:</p>
<p><img class="math" src="../_images/math/e3e355158f2fd80880ab1dcac1e4608dcc35ab3f.png" alt="\left|dv\right|&lt;PeakRadius" style="vertical-align: -5px"/></p>
<p>for the integration, one of the detector trajectories on the edge is too close to the peak
This method is also applied to all masked pixels.  If there are masked pixels trajectories inside an integration volume, the peak must be rejected.</p>
</div>
<div class="section" id="correctifonedge-option">
<h3><a class="toc-backref" href="#id10">CorrectIfOnEdge option</a><a class="headerlink" href="#correctifonedge-option" title="Permalink to this headline">¶</a></h3>
<p>This is an extension of what was calculated for the IntegrateIfOnEdge option.  It will only be calculated if this option
is true and the minimum dv is less than PeakRadius or BackgroundOuterRadius.</p>
<p>For the background if</p>
<p><img class="math" src="../_images/math/a72aafd57e6deb768b795d4f0010bf5fca6237f8.png" alt="\left|dv\right|_{min}&lt;BackgroundOuterRadius" style="vertical-align: -5px"/></p>
<p><img class="math" src="../_images/math/edf5c4ca48b78900679604b0d4eb5a8cd33414df.png" alt="h = BackgroundOuterRadius - \left|dv\right|_{min}" style="vertical-align: -5px"/></p>
<p>From the minimum of dv the volume of the cap of the sphere is found:</p>
<p><img class="math" src="../_images/math/8b777e6214ad3d124aeb33775bc26d737da1a583.png" alt="V_{cap} = \pi h^2 / 3 (3 * BackgroundOuterRadius - h)" style="vertical-align: -6px"/></p>
<p>The volume of the total sphere is calculated and for the background the volume of the inner radius must be subtracted:</p>
<p><img class="math" src="../_images/math/62beb576553db3e9630b4126faa8101651119dc2.png" alt="V_{shell} = 4/3 \pi (BackgroundOuterRadius^3 - BackgroundInnerRadius^3)" style="vertical-align: -5px"/></p>
<p>The integrated intensity is multiplied by the ratio of the volume of the sphere divided by the volume where data was collected</p>
<p><img class="math" src="../_images/math/ad15f2be33067e2151f5b3b1998fc68378e5b563.png" alt="I_{bkgMultiplier} = V_{shell} / (V_{shell} - V_{cap})" style="vertical-align: -6px"/></p>
<p>For the peak assume that the shape is Gaussian.  If</p>
<p><img class="math" src="../_images/math/668993069734819135defe31193dfbd7277e3ca5.png" alt="\left|dv\right|_{min}&lt;PeakRadius" style="vertical-align: -5px"/></p>
<p><img class="math" src="../_images/math/2aa70cff915d81a558f4eb62fea104a68cf2ccdd.png" alt="\sigma = PeakRadius / 3" style="vertical-align: -5px"/></p>
<p><img class="math" src="../_images/math/59369411c37d73366d1390025ba554de71c534e3.png" alt="h = PeakRadius * exp(-\left|dv\right|_{min}^2 / (2 \sigma^2)" style="vertical-align: -5px"/></p>
<p>From the minimum of dv the volume of the cap of the sphere is found:</p>
<p><img class="math" src="../_images/math/086c73a60e0c174ce877796fc7857d5135710400.png" alt="V_{cap} = \pi h^2 / 3 (3 * PeakRadius - h)" style="vertical-align: -6px"/></p>
<p>and the volume of the sphere is calculated</p>
<p><img class="math" src="../_images/math/d75b3fb14c3fb42ff924e2a54e551d144d8219df.png" alt="V_{sphere} = 4/3 \pi PeakRadius^3" style="vertical-align: -6px"/></p>
<p>The integrated intensity is multiplied by the ratio of the volume of the sphere divided by the volume where data was collected</p>
<p><img class="math" src="../_images/math/c292034f472e5d282905cc4fe6421209d3eea413.png" alt="I_{peakMultiplier} = V_{sphere} / (V_{sphere} - V_{cap})" style="vertical-align: -6px"/></p>
</div>
</div>
<div class="section" id="usage">
<h2><a class="toc-backref" href="#id11">Usage</a><a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p><strong>Example - IntegratePeaks:</strong></p>
<p>The code itself works but disabled from doc tests as takes too long to complete. User should provide its own
event nexus file instead of <strong>TOPAZ_3132_event.nxs</strong> used within this example. The original <strong>TOPAZ_3132_event.nxs</strong>
file is availible in <a class="reference external" href="https://github.com/mantidproject/systemtests/tree/master/Data/TOPAZ_3132_event.nxs">Mantid system tests repository</a>.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#.. testcode:: exIntegratePeaksMD</span>


<span class="k">def</span> <span class="nf">print_tableWS</span><span class="p">(</span><span class="n">pTWS</span><span class="p">,</span><span class="n">nRows</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Method to print part of the table workspace &#39;&#39;&#39;</span>
    <span class="n">tab_names</span><span class="o">=</span><span class="n">pTWS</span><span class="o">.</span><span class="n">keys</span><span class="p">();</span>

    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">tab_names</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">8</span><span class="p">:</span>
           <span class="n">name</span><span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">];</span>
        <span class="k">print</span> <span class="s">&quot;| {0:8} &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
    <span class="k">print</span> <span class="s">&quot;|</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nRows</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">tab_names</span><span class="p">:</span>
              <span class="n">col</span> <span class="o">=</span> <span class="n">pTWS</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
              <span class="n">data2pr</span><span class="o">=</span><span class="n">col</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
              <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data2pr</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">:</span>
                   <span class="k">print</span> <span class="s">&quot;| {0:8.3f} &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data2pr</span><span class="p">),</span>
              <span class="k">else</span><span class="p">:</span>
                  <span class="k">print</span> <span class="s">&quot;| {0:8} &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data2pr</span><span class="p">),</span>
        <span class="k">print</span> <span class="s">&quot;|</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>


 <span class="c"># Load a SCD data set and find the peaks</span>
<span class="n">LoadEventNexus</span><span class="p">(</span><span class="n">Filename</span><span class="o">=</span><span class="s">r&#39;TOPAZ_3132_event.nxs&#39;</span><span class="p">,</span><span class="n">OutputWorkspace</span><span class="o">=</span><span class="s">&#39;TOPAZ_3132_nxs&#39;</span><span class="p">)</span>
<span class="n">ConvertToDiffractionMDWorkspace</span><span class="p">(</span><span class="n">InputWorkspace</span><span class="o">=</span><span class="s">&#39;TOPAZ_3132_nxs&#39;</span><span class="p">,</span><span class="n">OutputWorkspace</span><span class="o">=</span><span class="s">&#39;TOPAZ_3132_md&#39;</span><span class="p">,</span><span class="n">LorentzCorrection</span><span class="o">=</span><span class="s">&#39;1&#39;</span><span class="p">)</span>
<span class="n">FindPeaksMD</span><span class="p">(</span><span class="n">InputWorkspace</span><span class="o">=</span><span class="s">&#39;TOPAZ_3132_md&#39;</span><span class="p">,</span><span class="n">PeakDistanceThreshold</span><span class="o">=</span><span class="s">&#39;0.15&#39;</span><span class="p">,</span><span class="n">MaxPeaks</span><span class="o">=</span><span class="s">&#39;100&#39;</span><span class="p">,</span><span class="n">OutputWorkspace</span><span class="o">=</span><span class="s">&#39;peaks&#39;</span><span class="p">)</span>
 <span class="n">FindUBUsingFFT</span><span class="p">(</span><span class="n">PeaksWorkspace</span><span class="o">=</span><span class="s">&#39;peaks&#39;</span><span class="p">,</span><span class="n">MinD</span><span class="o">=</span><span class="s">&#39;2&#39;</span><span class="p">,</span><span class="n">MaxD</span><span class="o">=</span><span class="s">&#39;16&#39;</span><span class="p">)</span>

 <span class="c"># Perform the peak integration, in-place in the &#39;peaks&#39; workspace.</span>
<span class="n">peaks</span><span class="o">=</span> <span class="n">IntegratePeaksMD</span><span class="p">(</span><span class="n">InputWorkspace</span><span class="o">=</span><span class="s">&#39;TOPAZ_3132_md&#39;</span><span class="p">,</span> <span class="n">PeaksWorkspace</span><span class="o">=</span><span class="s">&#39;peaks&#39;</span><span class="p">,</span>\
     <span class="n">PeakRadius</span><span class="o">=</span><span class="mf">0.12</span><span class="p">,</span> <span class="n">BackgroundOuterRadius</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">BackgroundInnerRadius</span><span class="o">=</span><span class="mf">0.16</span><span class="p">,</span>\
     <span class="n">OutputWorkspace</span><span class="o">=</span><span class="s">&#39;peaks&#39;</span><span class="p">)</span>

<span class="c"># print the integration results</span>
<span class="n">print_tableWS</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p><strong>Output:</strong></p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#.. testoutput:: exIntegratePeaksMD</span>

<span class="o">|</span> <span class="n">RunNumbe</span>  <span class="o">|</span> <span class="n">DetID</span>     <span class="o">|</span> <span class="n">h</span>         <span class="o">|</span> <span class="n">k</span>         <span class="o">|</span> <span class="n">l</span>         <span class="o">|</span> <span class="n">Waveleng</span>  <span class="o">|</span> <span class="n">Energy</span>    <span class="o">|</span> <span class="n">TOF</span>       <span class="o">|</span> <span class="n">DSpacing</span>  <span class="o">|</span> <span class="n">Intens</span>    <span class="o">|</span> <span class="n">SigInt</span>    <span class="o">|</span> <span class="n">BinCount</span>  <span class="o">|</span> <span class="n">BankName</span>  <span class="o">|</span> <span class="n">Row</span>       <span class="o">|</span> <span class="n">Col</span>       <span class="o">|</span> <span class="n">QLab</span>      <span class="o">|</span> <span class="n">QSample</span>   <span class="o">|</span>
<span class="o">|</span>     <span class="mi">3132</span>  <span class="o">|</span>  <span class="mi">1168976</span>  <span class="o">|</span>    <span class="mf">0.000</span>  <span class="o">|</span>    <span class="mf">0.000</span>  <span class="o">|</span>    <span class="mf">0.000</span>  <span class="o">|</span>    <span class="mf">1.106</span>  <span class="o">|</span>   <span class="mf">66.853</span>  <span class="o">|</span> <span class="mf">5161.495</span>  <span class="o">|</span>    <span class="mf">0.664</span>  <span class="o">|</span> <span class="mf">2161.555</span>  <span class="o">|</span>   <span class="mf">32.493</span>  <span class="o">|</span> <span class="mf">1042.000</span>  <span class="o">|</span> <span class="n">bank17</span>    <span class="o">|</span>   <span class="mf">80.000</span>  <span class="o">|</span>  <span class="mf">214.000</span>  <span class="o">|</span> <span class="p">[</span><span class="mf">4.42299</span><span class="p">,</span><span class="mf">2.80447</span><span class="p">,</span><span class="mf">7.87903</span><span class="p">]</span>  <span class="o">|</span> <span class="p">[</span><span class="mf">8.7569</span><span class="p">,</span><span class="mf">3.57474</span><span class="p">,</span><span class="o">-</span><span class="mf">0.211883</span><span class="p">]</span>  <span class="o">|</span>
<span class="o">|</span>     <span class="mi">3132</span>  <span class="o">|</span>  <span class="mi">1156499</span>  <span class="o">|</span>    <span class="mf">0.000</span>  <span class="o">|</span>    <span class="mf">0.000</span>  <span class="o">|</span>    <span class="mf">0.000</span>  <span class="o">|</span>    <span class="mf">2.081</span>  <span class="o">|</span>   <span class="mf">18.887</span>  <span class="o">|</span> <span class="mf">9708.954</span>  <span class="o">|</span>    <span class="mf">1.297</span>  <span class="o">|</span> <span class="mf">5137.547</span>  <span class="o">|</span>   <span class="mf">13.432</span>  <span class="o">|</span>  <span class="mf">828.000</span>  <span class="o">|</span> <span class="n">bank17</span>    <span class="o">|</span>  <span class="mf">147.000</span>  <span class="o">|</span>  <span class="mf">165.000</span>  <span class="o">|</span> <span class="p">[</span><span class="mf">2.49809</span><span class="p">,</span><span class="mf">1.45732</span><span class="p">,</span><span class="mf">3.88559</span><span class="p">]</span>  <span class="o">|</span> <span class="p">[</span><span class="mf">4.53003</span><span class="p">,</span><span class="mf">1.70942</span><span class="p">,</span><span class="mf">0.137013</span><span class="p">]</span>  <span class="o">|</span>
<span class="o">|</span>     <span class="mi">3132</span>  <span class="o">|</span>  <span class="mi">1156756</span>  <span class="o">|</span>    <span class="mf">0.000</span>  <span class="o">|</span>    <span class="mf">0.000</span>  <span class="o">|</span>    <span class="mf">0.000</span>  <span class="o">|</span>    <span class="mf">1.040</span>  <span class="o">|</span>   <span class="mf">75.677</span>  <span class="o">|</span> <span class="mf">4850.409</span>  <span class="o">|</span>    <span class="mf">0.648</span>  <span class="o">|</span> <span class="mf">1597.017</span>  <span class="o">|</span>   <span class="mf">30.643</span>  <span class="o">|</span>  <span class="mf">577.000</span>  <span class="o">|</span> <span class="n">bank17</span>    <span class="o">|</span>  <span class="mf">148.000</span>  <span class="o">|</span>  <span class="mf">166.000</span>  <span class="o">|</span> <span class="p">[</span><span class="mf">5.00569</span><span class="p">,</span><span class="mf">2.90696</span><span class="p">,</span><span class="mf">7.77943</span><span class="p">]</span>  <span class="o">|</span> <span class="p">[</span><span class="mf">9.06543</span><span class="p">,</span><span class="mf">3.43008</span><span class="p">,</span><span class="mf">0.281929</span><span class="p">]</span>  <span class="o">|</span>
<span class="o">|</span>     <span class="mi">3132</span>  <span class="o">|</span>  <span class="mi">1141779</span>  <span class="o">|</span>    <span class="mf">0.000</span>  <span class="o">|</span>    <span class="mf">0.000</span>  <span class="o">|</span>    <span class="mf">0.000</span>  <span class="o">|</span>    <span class="mf">1.704</span>  <span class="o">|</span>   <span class="mf">28.167</span>  <span class="o">|</span> <span class="mf">7952.321</span>  <span class="o">|</span>    <span class="mf">1.049</span>  <span class="o">|</span>  <span class="mf">648.434</span>  <span class="o">|</span>    <span class="mf">7.481</span>  <span class="o">|</span>  <span class="mf">379.000</span>  <span class="o">|</span> <span class="n">bank17</span>    <span class="o">|</span>   <span class="mf">19.000</span>  <span class="o">|</span>  <span class="mf">108.000</span>  <span class="o">|</span> <span class="p">[</span><span class="mf">2.61862</span><span class="p">,</span><span class="mf">2.31234</span><span class="p">,</span><span class="mf">4.86545</span><span class="p">]</span>  <span class="o">|</span> <span class="p">[</span><span class="mf">5.69642</span><span class="p">,</span><span class="mf">1.79732</span><span class="p">,</span><span class="o">-</span><span class="mf">0.443944</span><span class="p">]</span>  <span class="o">|</span>
<span class="o">|</span>     <span class="mi">3132</span>  <span class="o">|</span>  <span class="mi">1124982</span>  <span class="o">|</span>    <span class="mf">0.000</span>  <span class="o">|</span>    <span class="mf">0.000</span>  <span class="o">|</span>    <span class="mf">0.000</span>  <span class="o">|</span>    <span class="mf">1.555</span>  <span class="o">|</span>   <span class="mf">33.819</span>  <span class="o">|</span> <span class="mf">7256.594</span>  <span class="o">|</span>    <span class="mf">1.014</span>  <span class="o">|</span> <span class="mf">1990.427</span>  <span class="o">|</span>   <span class="mf">14.457</span>  <span class="o">|</span>  <span class="mf">330.000</span>  <span class="o">|</span> <span class="n">bank17</span>    <span class="o">|</span>  <span class="mf">118.000</span>  <span class="o">|</span>   <span class="mf">42.000</span>  <span class="o">|</span> <span class="p">[</span><span class="mf">3.14235</span><span class="p">,</span><span class="mf">2.43685</span><span class="p">,</span><span class="mf">4.75299</span><span class="p">]</span>  <span class="o">|</span> <span class="p">[</span><span class="mf">5.97935</span><span class="p">,</span><span class="mf">1.62817</span><span class="p">,</span><span class="o">-</span><span class="mf">0.00373607</span><span class="p">]</span>  <span class="o">|</span>
<span class="o">|</span>     <span class="mi">3132</span>  <span class="o">|</span>  <span class="mi">1170597</span>  <span class="o">|</span>    <span class="mf">0.000</span>  <span class="o">|</span>    <span class="mf">0.000</span>  <span class="o">|</span>    <span class="mf">0.000</span>  <span class="o">|</span>    <span class="mf">1.551</span>  <span class="o">|</span>   <span class="mf">34.005</span>  <span class="o">|</span> <span class="mf">7237.138</span>  <span class="o">|</span>    <span class="mf">0.951</span>  <span class="o">|</span> <span class="mf">1825.812</span>  <span class="o">|</span>   <span class="mf">14.812</span>  <span class="o">|</span>  <span class="mf">327.000</span>  <span class="o">|</span> <span class="n">bank17</span>    <span class="o">|</span>  <span class="mf">165.000</span>  <span class="o">|</span>  <span class="mf">220.000</span>  <span class="o">|</span> <span class="p">[</span><span class="mf">3.42477</span><span class="p">,</span><span class="mf">1.70221</span><span class="p">,</span><span class="mf">5.38678</span><span class="p">]</span>  <span class="o">|</span> <span class="p">[</span><span class="mf">6.06909</span><span class="p">,</span><span class="mf">2.59493</span><span class="p">,</span><span class="mf">0.276379</span><span class="p">]</span>  <span class="o">|</span>
<span class="o">|</span>     <span class="mi">3132</span>  <span class="o">|</span>  <span class="mi">1124982</span>  <span class="o">|</span>    <span class="mf">0.000</span>  <span class="o">|</span>    <span class="mf">0.000</span>  <span class="o">|</span>    <span class="mf">0.000</span>  <span class="o">|</span>    <span class="mf">3.111</span>  <span class="o">|</span>    <span class="mf">8.454</span>  <span class="o">|</span> <span class="mf">14514.017</span>  <span class="o">|</span>    <span class="mf">2.028</span>  <span class="o">|</span>  <span class="mf">749.742</span>  <span class="o">|</span>    <span class="mf">2.242</span>  <span class="o">|</span>  <span class="mf">268.000</span>  <span class="o">|</span> <span class="n">bank17</span>    <span class="o">|</span>  <span class="mf">118.000</span>  <span class="o">|</span>   <span class="mf">42.000</span>  <span class="o">|</span> <span class="p">[</span><span class="mf">1.57108</span><span class="p">,</span><span class="mf">1.21836</span><span class="p">,</span><span class="mf">2.37636</span><span class="p">]</span>  <span class="o">|</span> <span class="p">[</span><span class="mf">2.9895</span><span class="p">,</span><span class="mf">0.814038</span><span class="p">,</span><span class="o">-</span><span class="mf">0.00186793</span><span class="p">]</span>  <span class="o">|</span>
<span class="o">|</span>     <span class="mi">3132</span>  <span class="o">|</span>  <span class="mi">1232181</span>  <span class="o">|</span>    <span class="mf">0.000</span>  <span class="o">|</span>    <span class="mf">0.000</span>  <span class="o">|</span>    <span class="mf">0.000</span>  <span class="o">|</span>    <span class="mf">1.238</span>  <span class="o">|</span>   <span class="mf">53.388</span>  <span class="o">|</span> <span class="mf">5776.071</span>  <span class="o">|</span>    <span class="mf">0.934</span>  <span class="o">|</span> <span class="mf">3460.775</span>  <span class="o">|</span>   <span class="mf">25.974</span>  <span class="o">|</span> <span class="mf">1229.000</span>  <span class="o">|</span> <span class="n">bank18</span>    <span class="o">|</span>   <span class="mf">53.000</span>  <span class="o">|</span>  <span class="mf">205.000</span>  <span class="o">|</span> <span class="p">[</span><span class="mf">4.28486</span><span class="p">,</span><span class="mf">2.64933</span><span class="p">,</span><span class="mf">4.45466</span><span class="p">]</span>  <span class="o">|</span> <span class="p">[</span><span class="mf">6.52915</span><span class="p">,</span><span class="mf">1.2635</span><span class="p">,</span><span class="mf">0.998372</span><span class="p">]</span>  <span class="o">|</span>
<span class="o">|</span>     <span class="mi">3132</span>  <span class="o">|</span>  <span class="mi">1200023</span>  <span class="o">|</span>    <span class="mf">0.000</span>  <span class="o">|</span>    <span class="mf">0.000</span>  <span class="o">|</span>    <span class="mf">0.000</span>  <span class="o">|</span>    <span class="mf">1.433</span>  <span class="o">|</span>   <span class="mf">39.816</span>  <span class="o">|</span> <span class="mf">6687.166</span>  <span class="o">|</span>    <span class="mf">1.232</span>  <span class="o">|</span>  <span class="mf">963.069</span>  <span class="o">|</span>    <span class="mf">9.208</span>  <span class="o">|</span>  <span class="mf">990.000</span>  <span class="o">|</span> <span class="n">bank18</span>    <span class="o">|</span>  <span class="mf">151.000</span>  <span class="o">|</span>   <span class="mf">79.000</span>  <span class="o">|</span> <span class="p">[</span><span class="mf">3.37972</span><span class="p">,</span><span class="mf">2.40572</span><span class="p">,</span><span class="mf">2.9675</span><span class="p">]</span>  <span class="o">|</span> <span class="p">[</span><span class="mf">5.01065</span><span class="p">,</span><span class="mf">0.386939</span><span class="p">,</span><span class="mf">0.871633</span><span class="p">]</span>  <span class="o">|</span>
<span class="o">|</span>     <span class="mi">3132</span>  <span class="o">|</span>  <span class="mi">1218594</span>  <span class="o">|</span>    <span class="mf">0.000</span>  <span class="o">|</span>    <span class="mf">0.000</span>  <span class="o">|</span>    <span class="mf">0.000</span>  <span class="o">|</span>    <span class="mf">1.016</span>  <span class="o">|</span>   <span class="mf">79.240</span>  <span class="o">|</span> <span class="mf">4740.921</span>  <span class="o">|</span>    <span class="mf">0.776</span>  <span class="o">|</span> <span class="mf">2999.159</span>  <span class="o">|</span>   <span class="mf">35.467</span>  <span class="o">|</span>  <span class="mf">901.000</span>  <span class="o">|</span> <span class="n">bank18</span>    <span class="o">|</span>   <span class="mf">34.000</span>  <span class="o">|</span>  <span class="mf">152.000</span>  <span class="o">|</span> <span class="p">[</span><span class="mf">4.9551</span><span class="p">,</span><span class="mf">3.59367</span><span class="p">,</span><span class="mf">5.30453</span><span class="p">]</span>  <span class="o">|</span> <span class="p">[</span><span class="mf">7.96049</span><span class="p">,</span><span class="mf">1.19466</span><span class="p">,</span><span class="mf">0.899379</span><span class="p">]</span>  <span class="o">|</span>
</pre></div>
</td></tr></table></div>
<p><strong>Categories</strong>: <a class="reference external" href="categories/Algorithms.html">Algorithms</a> | <a class="reference external" href="categories/MDAlgorithms/Peaks.html">MDAlgorithms\Peaks</a></p>
</div>
<div class="section" id="source">
<h2><a class="toc-backref" href="#id12">Source</a><a class="headerlink" href="#source" title="Permalink to this headline">¶</a></h2>
<p>C++ source: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/3343e70222874fbd364099f979bd048987dd346c/Framework/MDAlgorithms/src/IntegratePeaksMD2.cpp">IntegratePeaksMD2.cpp</a></p>
<p>C++ header: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/3343e70222874fbd364099f979bd048987dd346c/Framework/MDAlgorithms/inc/MantidMDAlgorithms/IntegratePeaksMD2.h">IntegratePeaksMD2.h</a></p>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
      <ul class="nav navbar-nav" style=" float: right;">
      
      
          
            
  <li>
    <a href="IntegratePeaksMD-v1.html" title="Previous Chapter: IntegratePeaksMD v1"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; IntegratePeaksMD...</span>
    </a>
  </li>
  <li>
    <a href="IntegratePeaksMDHKL-v1.html" title="Next Chapter: IntegratePeaksMDHKL v1"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">IntegratePeaksMD... &raquo;</span>
    </a>
  </li>
          
       
          <li><a href="#">Back to top</a></li>
       </ul>
    <p>
    </p>
  </div>
</footer>
  </body>
</html>