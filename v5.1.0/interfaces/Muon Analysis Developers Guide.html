<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Muon Analysis: a guide for Mantid developers</title>
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.3.6/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.3.6/css/bootstrap-theme.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '5.1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Muon Elemental Analysis" href="Muon Elemental Analysis.html" />
    <link rel="prev" title="Muon Analysis" href="Muon Analysis 2.html" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59110517-1', 'auto');
  ga('send', 'pageview');

</script>


  </head>
  <body>





  <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://www.mantidproject.org"><img src="../_static/Mantid_Logo_Transparent.png">
           </a>
        <span class="navbar-text navbar-version pull-left"><b>5.1</b></span>
      </div>

      
        <div class="collapse navbar-collapse nav-collapse">
      
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
                <li><a href="http://www.mantidproject.org">Home</a></li>
                <li><a href="http://download.mantidproject.org">Download</a></li>
                <li><a href="http://docs.mantidproject.org/nightly/">Documentation</a></li>
                <li><a href="http://www.mantidproject.org/Contact">Contact Us</a></li>
            
            
              
              
            
            
            
            
          </ul>
              
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
            </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="section" id="muon-analysis-a-guide-for-mantid-developers">
<span id="muon-analysis-developersguide-ref"></span><h1>Muon Analysis: a guide for Mantid developers<a class="headerlink" href="#muon-analysis-a-guide-for-mantid-developers" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id1">Introduction</a></li>
<li><a class="reference internal" href="#what-the-interface-is-for" id="id2">What the interface is for</a><ul>
<li><a class="reference internal" href="#groups-and-periods" id="id3">Groups and Periods</a></li>
</ul>
</li>
<li><a class="reference internal" href="#loading-data" id="id4">Loading data</a><ul>
<li><a class="reference internal" href="#load-current-run" id="id5">Load current run</a></li>
<li><a class="reference internal" href="#muonanalysishelper" id="id6">MuonAnalysisHelper</a></li>
</ul>
</li>
<li><a class="reference internal" href="#plotting-data" id="id7">Plotting data</a></li>
<li><a class="reference internal" href="#fitting-data" id="id8">Fitting data</a><ul>
<li><a class="reference internal" href="#fit-function" id="id9">Fit function</a></li>
<li><a class="reference internal" href="#data" id="id10">Data</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sequence-of-events-when-fit-clicked" id="id11">Sequence of events when “Fit” clicked</a></li>
<li><a class="reference internal" href="#sequential-fit-dialog" id="id12">Sequential fit dialog</a></li>
<li><a class="reference internal" href="#after-a-fit" id="id13">After a fit</a></li>
<li><a class="reference internal" href="#generating-results-tables" id="id14">Generating results tables</a></li>
<li><a class="reference internal" href="#miscellaneous-notable-points" id="id15">Miscellaneous notable points</a></li>
<li><a class="reference internal" href="#future-work" id="id16">Future work</a></li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id1">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>This document is intended for Mantid developers as a guide to the architecture of the Muon Analysis custom interface.
User documentation for this interface can be found at <a class="reference internal" href="Muon Analysis.html#muon-analysis-ref"><span class="std std-ref">Muon Analysis (old)</span></a>.</p>
<p>There will be a particular focus on the <em>Data Analysis</em> tab, which has been significantly changed for Mantid 3.8.</p>
<p>Note that there is also another custom interface for muons: ALC. Development on this is much easier as it has an MVP architecture and is far better tested, so it will not be covered in this document.</p>
</div>
<div class="section" id="what-the-interface-is-for">
<h2><a class="toc-backref" href="#id2">What the interface is for</a><a class="headerlink" href="#what-the-interface-is-for" title="Permalink to this headline">¶</a></h2>
<p>Muon Analysis is for reducing and analysing data from muon instruments at ISIS and SMuS.
Muons are implanted into the sample and decay with a lifetime of about 2.2 microseconds.
The decay products (positrons) are detected and the signal measured is the count of positrons over time.</p>
<p>The instruments have many detectors (sometimes up to 600) in different positions, grouped spatially into “groups”.
In a typical muon spin resonance experiment, the muon spins precess in a magnetic field, meaning that the positron count seen on a particular detector will be modulated with time. This gives information about the local fields in the sample at the location where the muon is implanted.</p>
<p>Data is loaded into the interface, corrected for dead time, and the detectors grouped into groups.
For example, MuSR (64 detectors) uses two groups, <em>fwd</em> (forward, detectors 33-64) and <em>bwd</em> (backward, detectors 1-32) in its longitudinal field configuration, corresponding to the two detector rings.
(MuSR is special in that the main field direction can be rotated either longitudinal or transverse).
In this case scientists will usually look at a “group pair” called <em>long</em>, defined as <em>fwd - bwd</em>.</p>
<p>The grouping used is taken from the IDF by default, or from the data file if not present.
The user can also specify their own grouping.</p>
<p>The counts or log counts can be plotted, but what scientists usually want to look at is the <strong>asymmetry</strong> (see below).</p>
<p>Processing is done using the workflow algorithm <a class="reference internal" href="../algorithms/MuonProcess-v1.html#algm-muonprocess"><span class="std std-ref">MuonProcess v1</span></a> - see there for a fuller explanation and diagram of the steps performed.</p>
<p>The “Data Analysis” tab is then used to fit a function to the data, and tables of the results from such fits can be generated with the “Results Table” tab.</p>
<p>For a full explanation of what the interface does and how to use it, please see the user docs.
Other useful documents are the “Mantid 4 Muons” document and the training school workbook, both of which can be found on the <a class="reference external" href="http://www.mantidproject.org/Muon">Muon page</a>.</p>
<div class="section" id="groups-and-periods">
<h3><a class="toc-backref" href="#id3">Groups and Periods</a><a class="headerlink" href="#groups-and-periods" title="Permalink to this headline">¶</a></h3>
<p>Groups are explained above, as sets of detectors corresponding to physical arrangements.
For example, the MuSR instrument has two rings of detectors, leading to two detector groups in the longitudinal field arrangement.</p>
<p><em>Periods</em> refers to collecting data in several periods of time - for example you might have two periods “RF on” and “RF off” or “laser on” and “laser off”.
The interface allows users to analyse one period at a time, or a sum/difference (such as “1+2”, “1-2” or even “1+2-3+4”).</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Note that for summed periods (1+2), you sum the periods 1 and 2 first, then calculate the asymmetry of the sum. For subtracted periods (1-2), you calculate the asymmetry of each period separately, then subtract the asymmetry of period 2 from that of period 1. So for 1+2-3+4, you sum 1+2 and 3+4, calculate asymmetry of each sum, then subtract the asymmetry of (3+4) from that of (1+2).</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We don’t support names of periods yet, they are referred to by number. This is something scientists would like to have in the future, though. The names are stored in the NeXus file.</p>
</div>
<div class="topic">
<p class="topic-title first">Asymmetry example</p>
<p>Let’s look at a group first - the <em>fwd</em> group of <code class="docutils literal"><span class="pre">MUSR00022725.nxs</span></code>.
For a group, you get the asymmetry simply by removing the exponential decay:</p>
<img alt="../_images/MUSR22725-fwd.png" class="align-center" src="../_images/MUSR22725-fwd.png" />
<p>Now let’s look at a group pair - the <em>long</em> pair (<em>fwd - bwd</em>) of <code class="docutils literal"><span class="pre">MUSR00060625.nxs</span></code>.
For this, the asymmetry is defined as (see <a class="reference internal" href="../algorithms/AsymmetryCalc-v1.html#algm-asymmetrycalc"><span class="std std-ref">AsymmetryCalc v1</span></a>)</p>
<div class="math">
<p><img src="../_images/math/0d1b573dd86c1d958faa4d0c7ec48e3510325ed3.png" alt="\textrm{Asymmetry} = \frac{F-\alpha B}{F+\alpha B}"/></p>
</div><p>where <img class="math" src="../_images/math/68b0fc4683e0c8842b3a6cc6920f022f1c0db3fa.png" alt="F" style="vertical-align: 0px"/> is the front spectra, <img class="math" src="../_images/math/fd8a1eb9153f0dc573e5ebe023a59474dadd17ef.png" alt="B" style="vertical-align: 0px"/> is the back spectra
and <img class="math" src="../_images/math/23bf3bdd8ce99fdb75f17e8b49934c62e9cf0841.png" alt="\alpha" style="vertical-align: 0px"/> is the balance parameter - see <a class="reference internal" href="../algorithms/AlphaCalc-v1.html#algm-alphacalc"><span class="std std-ref">AlphaCalc v1</span></a>.</p>
<img alt="../_images/MUSR60625-long.png" class="align-center" src="../_images/MUSR60625-long.png" />
</div>
</div>
</div>
<div class="section" id="loading-data">
<h2><a class="toc-backref" href="#id4">Loading data</a><a class="headerlink" href="#loading-data" title="Permalink to this headline">¶</a></h2>
<p>Data is loaded into the interface as NeXus files. This is the only file type supported at the moment.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Converters exist to translate most other formats (e.g. older ISIS files) to NeXus. PSI have a program called <code class="docutils literal"><span class="pre">any2many</span></code> that will convert their <code class="docutils literal"><span class="pre">BIN</span></code> files to NeXus.</p>
</div>
<p>Muon NeXus files come in two versions, v1 and v2, and there are two versions of the <a class="reference internal" href="../algorithms/LoadMuonNexus-v2.html#algm-loadmuonnexus"><span class="std std-ref">LoadMuonNexus v2</span></a> algorithm to handle them.
Both v1 and v2 are in active use (in fact most ISIS data is v1 at the moment).
The schema can be found on the <a class="reference external" href="http://www.isis.stfc.ac.uk/groups/muons/muons3385.html">muon group website</a>, and Steve Cottrell is the best person to ask about NeXus-related questions at ISIS.
Version 2 files support multiple detectors per spectrum, which version 1 files don’t. This isn’t used on any instruments at ISIS at the time of writing.</p>
<p>Which data is loaded from which place in the NeXus file, and where it is put in the workspace/run object, is well documented for both versions of the algorithm in their algorithm doc pages.</p>
<p>There are also some “version 0” muon NeXus files. These are old, pre-NeXus files that have been converted to NeXus.
These mostly load OK into Mantid, but sometimes may be missing something that the loader is expecting.
In one case, there used to be an instrument at ISIS called DEVA, which is not there any more and does not have an IDF (at the moment there is a hack to allow old DEVA files to be loaded).</p>
<p>The class <code class="docutils literal"><span class="pre">MuonAnalysisDataLoader</span></code> handles loading files and creating analysis workspaces using <a class="reference internal" href="../algorithms/MuonProcess-v1.html#algm-muonprocess"><span class="std std-ref">MuonProcess v1</span></a>.
It is fully tested, in addition to the tests that the algorithms themselves have.</p>
<p>The grouping is stored in a <code class="docutils literal"><span class="pre">Mantid::API::Grouping</span></code> struct. The user can specify their own grouping on the “Grouping Options” tab, and a <code class="docutils literal"><span class="pre">MuonGroupingHelper</span></code> object is used to deal with this. (This is not tested as it is too coupled to the GUI - needs refactoring).</p>
<div class="section" id="load-current-run">
<h3><a class="toc-backref" href="#id5">Load current run</a><a class="headerlink" href="#load-current-run" title="Permalink to this headline">¶</a></h3>
<p><strong>ISIS only</strong></p>
<p>Scientists at ISIS often use the “load current run” feature - a button on the front tab that will load the most recent data file from the selected instrument. The button is not enabled at other facilities, where this feature is not available.</p>
<p>The location of the current run is kept in <code class="docutils literal"><span class="pre">\\&lt;instrument&gt;\data\autosave.run</span></code>, a file that points to another file in the same directory where the data is.
For example, <code class="docutils literal"><span class="pre">\\MUSR\data\autosave.run</span></code> might contain the file name <code class="docutils literal"><span class="pre">auto_B.tmp</span></code>, meaning that the current data is in <code class="docutils literal"><span class="pre">\\MUSR\data\auto_B.tmp</span></code>.</p>
<p>After loading the current run, the left/right buttons are used to cycle through recent datasets.</p>
<p>At present the “load current run” feature is Windows only, due to how the shared data folder is accessed - at the moment this is OK, as most muon scientists at ISIS tend to use Windows, but it would be good to fix in the long run.</p>
</div>
<div class="section" id="muonanalysishelper">
<h3><a class="toc-backref" href="#id6">MuonAnalysisHelper</a><a class="headerlink" href="#muonanalysishelper" title="Permalink to this headline">¶</a></h3>
<p>On the whole, the main part of MuonAnalysis uses the “big ball of mud” design pattern.
It is very difficult to write tests because the logic is mixed up with the GUI code.
There is, however, a namespace called <code class="docutils literal"><span class="pre">MuonAnalysisHelper</span></code> which contains non-GUI MuonAnalysis-related functions, and these do have tests.</p>
<p>As noted above, data loading/processing is handled with <code class="docutils literal"><span class="pre">MuonAnalysisDataLoader</span></code>, which is also tested.</p>
<div class="topic">
<p class="topic-title first">Workspace names in MuonAnalysis</p>
<p><code class="docutils literal"><span class="pre">MuonAnalysisHelper</span></code> is also where the generation and parsing of workspace names is done.
In the Muon Analysis interface, these follow a strict format delimited by semicolons:</p>
<p><code class="docutils literal"><span class="pre">INST00012345;</span> <span class="pre">Pair;</span> <span class="pre">long;</span> <span class="pre">Asym;[</span> <span class="pre">1;]</span> <span class="pre">#1</span></code></p>
<ol class="arabic simple">
<li>Run label, made up of instrument and run number.</li>
<li>“Item type”: Group (e.g. <em>fwd</em>, <em>bwd</em>) or Pair (e.g. <em>long</em>).</li>
<li>Name of the group or pair.</li>
<li>Plot type: Counts, Logs (logarithm) or Asym (asymmetry).</li>
<li><strong>Optional:</strong> Period number, or combination like <code class="docutils literal"><span class="pre">1+2</span></code>. If not present, data is single-period OR all periods are summed together.</li>
<li>Version: always <code class="docutils literal"><span class="pre">#1</span></code> if overwrite is on (Settings tab of interface), otherwise auto-increments.</li>
</ol>
<p>The suffix <code class="docutils literal"><span class="pre">_Raw</span></code> is appended if rebinning is used, to denote the un-rebinned data.</p>
</div>
</div>
</div>
<div class="section" id="plotting-data">
<h2><a class="toc-backref" href="#id7">Plotting data</a><a class="headerlink" href="#plotting-data" title="Permalink to this headline">¶</a></h2>
<p>To plot data, Muon Analysis uses a hard-coded Python script in the <code class="docutils literal"><span class="pre">plotSpectrum</span></code> method, which is run via the <code class="docutils literal"><span class="pre">runPythonScript</span></code> method common to all Mantid custom interfaces.
(I wonder if there is a better way to do this? It is difficult to maintain the plotting script when it is a string within a C++ method).</p>
<p>There are various options set on the Settings page - see the user docs for more information on these:</p>
<ul class="simple">
<li>Use a new window each time, or the previous window</li>
<li>Whether it replots automatically, or waits for the “Plot” button to be pressed</li>
<li>Y autoscale or fixed scale</li>
<li>Curve type and errors on/off</li>
</ul>
<p>Note that, as well as plotting from the front tab, there are “Plot” buttons on the “Grouping Options” tab too.</p>
<p>Another important point is the setting for “rebin options” on the settings page.
If set, rebinned data will be plotted, and analysis workspaces will be created for <em>both</em> rebinned and raw data.
Often, scientists will use the rebinning option but choose the “Fit to raw data” option on the fitting tab.</p>
<p>If reusing the previous plot window, previous fit curves are kept when new raw data is loaded.
The number of such curves kept is user-configurable.
The script recognises which curves are fits by their name: <code class="docutils literal"><span class="pre">Workspace-Calc</span></code>.
It will also keep any “plot guesses”, which are recognised by the name <code class="docutils literal"><span class="pre">CompositeFunction</span></code>.</p>
</div>
<div class="section" id="fitting-data">
<h2><a class="toc-backref" href="#id8">Fitting data</a><a class="headerlink" href="#fitting-data" title="Permalink to this headline">¶</a></h2>
<p>The Muon Analysis fitting (“Data Analysis”) tab was updated in Mantid 3.8 to support multi-dataset fitting.
Its features are described in the user documentation; this section concentrates on its architecture.</p>
<p>Prior to Mantid 3.8, this tab contained one thing: a <code class="docutils literal"><span class="pre">FitPropertyBrowser</span></code> (actually a <code class="docutils literal"><span class="pre">MuonFitPropertyBrowser</span></code>).</p>
<img alt="../_images/MuonAnalysisDataAnalysis.png" class="align-center" src="../_images/MuonAnalysisDataAnalysis.png" />
<p>This is still there, but only the bottom section (“Settings”) and the three buttons at the top are visible.
The “Function” and “Data” sections are hidden.
In their place are two new widgets - this is achieved by inserting an extra <code class="docutils literal"><span class="pre">Layout</span></code> into the muon fit property browser and adding the widgets to this layout.</p>
<p>The above assumes that the “Enable multiple fitting” option is selected on the Settings tab.
Since the <code class="docutils literal"><span class="pre">MuonFitPropertyBrowser</span></code> is all still there underneath, deselecting this option will hide the new widgets and show the previously hidden sections of the fit browser - note that, at present this option is <em>deselected</em> by default (i.e. the interface has the old UI).</p>
<p>This tab can be thought of as something like an MVP (model-view-presenter) architecture.
Of course, it’s not <em>properly</em> MVP, as that would have required a rewrite - the focus was on reusing as much existing code as possible!</p>
<div class="topic">
<p class="topic-title first">“MVP-like” design</p>
<img alt="../_images/mvp_muon.png" class="align-center" src="../_images/mvp_muon.png" />
<p><strong>Model:</strong> the <code class="docutils literal"><span class="pre">MuonFitPropertyBrowser</span></code>. Still performs the actual fit, keeps track of the workspace(s) fitted, and raises events (Qt signals) to notify the presenters.</p>
<p>This model is shared between two presenter/view pairs, one to deal with the fitting function and one to deal with the data that will be fitted.</p>
<p>It inherits from two new abstract base classes (i.e. implements two interfaces), so that it can be mocked when testing the two presenters.</p>
<p><strong>Views:</strong></p>
<ul>
<li><p class="first">Fit function: <code class="docutils literal"><span class="pre">FunctionBrowser</span></code> - the same one used in the general multi-fitting interface. It is reused here, with the only change being to restrict the range of functions shown to only those that are of interest to muon scientists.</p>
<p>The <code class="docutils literal"><span class="pre">FunctionBrowser</span></code>, as a pre-existing Mantid widget, is not a very humble view and has some logic inside it which unfortunately cannot be tested.</p>
</li>
<li><p class="first">Data: a <code class="docutils literal"><span class="pre">MuonFitDataSelector</span></code>, a new widget written as a humble view. It does as little as possible and leaves all the logic to the presenter.</p>
</li>
</ul>
<p>Both these views inherit from abstract base classes - this is for mocking purposes when testing the presenters.</p>
<p><strong>Presenters:</strong></p>
<ul class="simple">
<li>Fit function: <code class="docutils literal"><span class="pre">MuonAnalysisFitFunctionPresenter</span></code></li>
<li>Data: <code class="docutils literal"><span class="pre">MuonAnalysisFitDataPresenter</span></code></li>
</ul>
<p>Both presenters have unit tests. The relevant views, and relevant part of the model, are mocked out for this purpose.</p>
</div>
<div class="section" id="fit-function">
<h3><a class="toc-backref" href="#id9">Fit function</a><a class="headerlink" href="#fit-function" title="Permalink to this headline">¶</a></h3>
<p>The actual function that is going to be fitted to the data is stored in the <code class="docutils literal"><span class="pre">MuonFitPropertyBrowser</span></code> (model) and, after the fit, this function will have the correct parameter values.</p>
<p>It is therefore the job of the presenter to</p>
<ul class="simple">
<li>Update the model’s function when the user changes the function in the view</li>
<li>Update the view’s displayed function parameters when the fit has finished.</li>
</ul>
<p>There are also some signals that come from the data presenter, when the user has used the <code class="docutils literal"><span class="pre">&lt;&lt;</span></code> or <code class="docutils literal"><span class="pre">&gt;&gt;</span></code> buttons to change datasets, or changed the number of workspaces to fit. In these cases the <code class="docutils literal"><span class="pre">FunctionBrowser</span></code> must be updated with this information, to set the number of datasets or to change which dataset’s parameters are being displayed.</p>
</div>
<div class="section" id="data">
<h3><a class="toc-backref" href="#id10">Data</a><a class="headerlink" href="#data" title="Permalink to this headline">¶</a></h3>
<p>When the user changes something in the <code class="docutils literal"><span class="pre">MuonFitDataSelector</span></code> view, for example the runs to fit, selected groups/periods, fit type (single/co-add/simultaneous) or simultaneous fit label, an event is raised to notify the presenter.
This gets the relevant information from the view and updates the model with it.</p>
<p>(In a couple of cases, the signal actually goes via <code class="docutils literal"><span class="pre">MuonAnalysis</span></code> itself - because the grouping and plot type may have been changed by the user in that GUI, and so they need to be updated too).</p>
<p>If the user’s chosen runs/groups/periods include datasets that haven’t had workspaces created for them yet, they will be created at that point, rather than just before the fit.
Note that, when “Fit raw data” has been ticked, two workspaces must be created per dataset - one binned and one raw.
The data presenter uses a <code class="docutils literal"><span class="pre">MuonAnalysisDataLoader</span></code> (see earlier) to create the analysis workspaces.</p>
<p>The case where the user updates the fitting range by dragging lines on the graph is also dealt with by the data presenter.</p>
<p>When a new dataset is loaded on the Home tab, this assigns a new “first run”.
(Intended use case is that the first run will always be the one specified on the Home tab).
The presenter therefore updates the view’s selected group/period in this case.</p>
<p>When a fit is finished, the data presenter is notified so that it can process the results.
This is only relevant in the case of a simultaneous fit, because the <a class="reference internal" href="../algorithms/Fit-v1.html#algm-fit"><span class="std std-ref">Fit v1</span></a> algorithm produces output in a very different form to its regular output format.
The presenter reorganises the output workspaces so that they are in the same format as they would have been for a regular fit - and then they can be easily read by the “Results table” tab.</p>
</div>
</div>
<div class="section" id="sequence-of-events-when-fit-clicked">
<h2><a class="toc-backref" href="#id11">Sequence of events when “Fit” clicked</a><a class="headerlink" href="#sequence-of-events-when-fit-clicked" title="Permalink to this headline">¶</a></h2>
<p>The “Fit” button is part of the <em>MuonFitPropertyBrowser</em>, i.e. the model. This doesn’t fit with the MVP pattern but is this way for historical reasons, as the button was always part of this widget.</p>
<p>When the user clicks “Fit”, the model emits a signal <code class="docutils literal"><span class="pre">preFitChecksRequested</span></code>. This is caught by the data presenter, which performs some checks that the data is valid before the fit starts. Extra checks could be easily added at this point.</p>
<p>If everything is OK, the data presenter tells the model to continue, and the model emits <code class="docutils literal"><span class="pre">functionUpdateAndFitRequested</span></code>.
This signal is caught by the function presenter, which updates the fit function in the model from that in the view, to ensure they are in sync before the fit. It then tells the model to start the fit.</p>
</div>
<div class="section" id="sequential-fit-dialog">
<h2><a class="toc-backref" href="#id12">Sequential fit dialog</a><a class="headerlink" href="#sequential-fit-dialog" title="Permalink to this headline">¶</a></h2>
<p>This is opened when the user selects <em>Fit/Sequential Fit</em>.
A sequential fit runs the same fit (either one group/period or a simultaneous fit over groups/periods for one run) for one run at a time, over several runs in sequence.
For example, fits group <em>fwd</em>, period 1 for run 15189, then the same group/period for run 15190, then run 15191…</p>
<p>The dialog <code class="docutils literal"><span class="pre">MuonSequentialFitDialog</span></code> is part of the <code class="docutils literal"><span class="pre">CustomInterfaces</span></code> project.
It holds pointers to the <code class="docutils literal"><span class="pre">MuonAnalysisFitDataPresenter</span></code> (which creates the workspaces to fit and processes the fitted workspaces) and to the <code class="docutils literal"><span class="pre">MuonFitPropertyBrowser</span></code> (“Model” - the dialog gets the fit function and properties from here).</p>
<p>The actual fit is done by calling the <a class="reference internal" href="../algorithms/Fit-v1.html#algm-fit"><span class="std std-ref">Fit v1</span></a> algorithm from the sequential fit dialog.</p>
<p>One point to note is that the fit is done in two stages.
On pressing the Fit button, the <code class="docutils literal"><span class="pre">startFit</span></code> method is called - this starts running the file search from the <code class="docutils literal"><span class="pre">FileFinderWidget</span></code> (run number input widget).
When the <code class="docutils literal"><span class="pre">FileFinderWidget</span></code> widget signals that it has found the relevant files, only then does the fit process continue in <code class="docutils literal"><span class="pre">continueFit</span></code>.
The reason for this is because users can type a range of runs into the box and then immediately hit Return or click Fit, without first clicking outside the box - and we need time to do the file search before starting.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Despite their names, <code class="docutils literal"><span class="pre">MuonSequentialFitDialog</span></code> does <em>not</em> inherit from <code class="docutils literal"><span class="pre">SequentialFitDialog</span></code> - they are completely separate classes. I assume this is for historical reasons. Amongst other differences, the muon sequential fit dialog calls <a class="reference internal" href="../algorithms/Fit-v1.html#algm-fit"><span class="std std-ref">Fit v1</span></a> multiple times while the general sequential fit dialog uses <a class="reference internal" href="../algorithms/PlotPeakByLogValue-v1.html#algm-plotpeakbylogvalue"><span class="std std-ref">PlotPeakByLogValue v1</span></a>.</p>
</div>
</div>
<div class="section" id="after-a-fit">
<h2><a class="toc-backref" href="#id13">After a fit</a><a class="headerlink" href="#after-a-fit" title="Permalink to this headline">¶</a></h2>
<p>After fitting a single dataset, the plot is automatically updated with the fit curve and difference (if “Plot Difference” is selected).
This is done by the <code class="docutils literal"><span class="pre">PeakPickerTool</span></code> from MantidPlot, not by anything within Muon Analysis.</p>
<p>(The <code class="docutils literal"><span class="pre">PeakPickerTool</span></code> is set to the plot when the Data Analysis tab is selected - see box below.)</p>
<p>The <code class="docutils literal"><span class="pre">PeakPickerTool</span></code> can recognise muon data by noticing that the fit property browser is a <code class="docutils literal"><span class="pre">MuonFitPropertyBrowser</span></code>.
In this case it doesn’t remove previous fit curves like it would for other graphs, because this is handled by Muon Analysis instead - we have the option there to keep <em>n</em> previous fits as selected by the user…</p>
<p>If it notes that the fit was a <em>simultaneous</em> fit of muon data, then <strong>nothing is plotted</strong>.
This is a temporary solution.
In the long run, we need to discuss with scientists what they would like to be plotted when a simultaneous fit ends.
(N.B. We need to avoid the situation of automatically trying to make a tiled plot of hundreds of datasets at once!)</p>
<p>What users can currently do to plot the results of a simultaneous or sequential fit is to right-click on the workspace group (<code class="docutils literal"><span class="pre">MuonSimulFit_&lt;Label&gt;</span></code> or <code class="docutils literal"><span class="pre">MuonSeqFit_&lt;Label&gt;</span></code>) and select <em>Plot Spectrum…</em>, then use the <em>Tiled Plot</em> option.
Probably it would be best to make this automatic when a multiple fit ends, or provide a “Plot” button in Muon Analysis - this would most likely require exposing the relevant tiled plot functionality to Python first.</p>
<div class="topic">
<p class="topic-title first">Changing tabs in Muon Analysis</p>
<p>Changing tabs is handled by the <code class="docutils literal"><span class="pre">changeTab</span></code> method in <code class="docutils literal"><span class="pre">MuonAnalysis.cpp</span></code>.
When entering the <em>Data Analysis</em> tab:</p>
<ul class="simple">
<li>The <code class="docutils literal"><span class="pre">MuonFitPropertyBrowser</span></code> on this tab is set as the default, rather than Mantid’s general fit property browser</li>
<li>Fitting range (start/end) is initialised, unless one is already set</li>
<li>The <code class="docutils literal"><span class="pre">PeakPickerTool</span></code> is attached to the current plot</li>
<li>The currently selected workspace is set in the fit data presenter</li>
<li>The current value of the Mantid-wide setting <code class="docutils literal"><span class="pre">curvefitting.peakRadius</span></code> is cached, and its value is changed to 99. Muon scientists requested this as they don’t fit peaks on this tab. The change is localised only to while the <em>Data Analysis</em> tab is open, and the cached value will be restored on leaving this tab.</li>
</ul>
<p>When leaving the <em>Data Analysis</em> tab, the reverse happens:</p>
<ul class="simple">
<li>Default fit browser in MantidPlot is reset to Mantid’s default</li>
<li>The config option <code class="docutils literal"><span class="pre">curvefitting.peakRadius</span></code> is reset to its cached value</li>
<li>The <code class="docutils literal"><span class="pre">PeakPickerTool</span></code> is disconnected from the plot</li>
</ul>
</div>
</div>
<div class="section" id="generating-results-tables">
<h2><a class="toc-backref" href="#id14">Generating results tables</a><a class="headerlink" href="#generating-results-tables" title="Permalink to this headline">¶</a></h2>
<p>The “Results table” tab is structured with <code class="docutils literal"><span class="pre">MuonAnalysisResultTableTab</span></code> handling the GUI parts - populating the tables and getting the user’s choice - and uses a <code class="docutils literal"><span class="pre">MuonAnalysisResultTableCreator</span></code> object to actually create the table.</p>
<p>The <code class="docutils literal"><span class="pre">MuonAnalysisResultTableCreator</span></code> is tested as it doesn’t use the GUI, but the tab class itself does not have tests.</p>
<p>The user can tick time-series logs to add to the table, and a few non-timeseries logs are available too. These are:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">run_number</span></code></li>
<li><code class="docutils literal"><span class="pre">run_start</span></code>, <code class="docutils literal"><span class="pre">run_end</span></code>: either as seconds relative to first run start, or ISO-formatted text</li>
<li><code class="docutils literal"><span class="pre">sample_temp</span></code></li>
<li><code class="docutils literal"><span class="pre">sample_magn_field</span></code></li>
<li><code class="docutils literal"><span class="pre">group</span></code> and <code class="docutils literal"><span class="pre">period</span></code> - these are not logs from the NeXus file but, in the case of a simultaneous fit, the <code class="docutils literal"><span class="pre">MuonFitDataPresenter</span></code> adds them to the fitted workspace (in <code class="docutils literal"><span class="pre">addSpecialLogs</span></code>).</li>
</ul>
<p>The results table creator must check the workspaces have the same fit model, add the right columns and populate them with values.
The columns must have the correct plot type (X, Y, YError or Label).
If a parameter was fixed in the fit, its error will be zero for each row - so that error column can be removed.</p>
<p>The <em>Multiple</em> option is a little different to the others.
While the single, sequential or simultaneous fit tables have one row per dataset, the multiple fit table has one row per label - showing many fits in the same table, one row per fit.
A <em>global</em> parameter has just one value column and one error column, while other (non-global) parameters have one value and one error column per dataset.</p>
<p>The results table creator can recognise a global parameter by the fact that it has the same value for all datasets.</p>
</div>
<div class="section" id="miscellaneous-notable-points">
<h2><a class="toc-backref" href="#id15">Miscellaneous notable points</a><a class="headerlink" href="#miscellaneous-notable-points" title="Permalink to this headline">¶</a></h2>
<p>For a long time, using the Muon Analysis interface has produced a mysterious black box in the toolbars of MantidPlot:</p>
<img alt="../_images/blackbox.png" class="align-center" src="../_images/blackbox.png" />
<p>This is caused by using the “Hide Toolbars” option on the Settings tab.
If selected, MantidPlot emits a <code class="docutils literal"><span class="pre">setToolbarsHidden(true)</span></code> signal, which is caught by MantidPlot, hiding all the toolbars.
The option is meant to be helpful for users with small laptop screens.</p>
<p>However, when the interface is closed/hidden, the reverse <code class="docutils literal"><span class="pre">setToolbarsHidden(false)</span></code> tells MantidPlot to show <em>all</em> the toolbars, even ones that the user didn’t have displayed in the first place!
There is no cache of which toolbars were displayed, and no control over which to show - it’s all or none.</p>
<p>The “black box” seen in the image is, in fact, one of the toolbars - the “Data Display” one.
This is used by the “Screen reader” feature in MantidPlot, which displays coordinates from a graph.
When no graph is being read, the toolbar appears as an empty black box, as above.</p>
</div>
<div class="section" id="future-work">
<h2><a class="toc-backref" href="#id16">Future work</a><a class="headerlink" href="#future-work" title="Permalink to this headline">¶</a></h2>
<p>Open muon issues can be found on Github with the <a class="reference external" href="https://github.com/mantidproject/mantid/issues?q=is%3Aopen+is%3Aissue+label%3A%22Component%3A+Muon%22">Component: Muon</a> label.
Those marked <code class="docutils literal"><span class="pre">Misc:</span> <span class="pre">Roadmap</span></code> are the most important.</p>
<p><strong>Categories</strong>: <a class="reference external" href="categories/Interfaces.html">Interfaces</a> | <a class="reference external" href="../algorithms/categories/Muon.html">Muon</a></p>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
      <ul class="nav navbar-nav" style=" float: right;">
      
      
          
            
  <li>
    <a href="Muon Analysis 2.html" title="Previous Chapter: Muon Analysis"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Muon Analysis</span>
    </a>
  </li>
  <li>
    <a href="Muon Elemental Analysis.html" title="Next Chapter: Muon Elemental Analysis"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Muon Elementa... &raquo;</span>
    </a>
  </li>
          
       
          <li><a href="#">Back to top</a></li>
       </ul>
    <p>
      Last updated on 2020-09-29.<br/>
    </p>
  </div>
</footer>
  </body>
</html>