<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>RefinePowderInstrumentParameters v3</title>
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.3.6/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.3.6/css/bootstrap-theme.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '6.4.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="ReflectometryBackgroundSubtraction v1" href="ReflectometryBackgroundSubtraction-v1.html" />
    <link rel="prev" title="RefinePowderDiffProfileSeq v1" href="RefinePowderDiffProfileSeq-v1.html" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59110517-1', 'auto');
  ga('send', 'pageview');

</script>


  </head>
  <body>





  <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://www.mantidproject.org"><img src="../_static/Mantid_Logo_Transparent.png">
           </a>
        <span class="navbar-text navbar-version pull-left"><b>6.4</b></span>
      </div>

      
        <div class="collapse navbar-collapse nav-collapse">
      
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
                <li><a href="http://www.mantidproject.org">Home</a></li>
                <li><a href="http://download.mantidproject.org">Download</a></li>
                <li><a href="http://docs.mantidproject.org/nightly/">Documentation</a></li>
                <li><a href="http://www.mantidproject.org/Contact">Contact Us</a></li>
            
            
              
              
            
            
            
            
          </ul>
              
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
            </div>
    </div>
    <p>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="../index.html">Documentation</a> &#187;</li>
        
            <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Algorithms</a> &#187;</li>
          
        
        
          
            <li class="nav-item nav-item-this"><a href="">RefinePowderInstrumentParameters v3</a></li>
          
        
      </ul>
    </div> </p>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <p><span class="math">\(\renewcommand\AA{\unicode{x212B}}\)</span></p>
<div class="section" id="refinepowderinstrumentparameters-v3">
<span id="algm-refinepowderinstrumentparameters"></span><span id="algm-refinepowderinstrumentparameters-v3"></span><h1>RefinePowderInstrumentParameters v3<a class="headerlink" href="#refinepowderinstrumentparameters-v3" title="Permalink to this headline">¶</a></h1>
<div class="figure align-right" id="id1">
<span id="index-0"></span><a class="screenshot reference internal image-reference" href="../_images/RefinePowderInstrumentParameters-v3_dlg.png"><img alt="../_images/RefinePowderInstrumentParameters-v3_dlg.png" class="screenshot" src="../_images/RefinePowderInstrumentParameters-v3_dlg.png" style="width: 349px;" /></a>
<p class="caption"><span class="caption-text"><strong>RefinePowderInstrumentParameters</strong> dialog.</span></p>
</div>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#summary" id="id2">Summary</a><ul>
<li><a class="reference internal" href="#see-also" id="id3">See Also</a></li>
</ul>
</li>
<li><a class="reference internal" href="#properties" id="id4">Properties</a></li>
<li><a class="reference internal" href="#description" id="id5">Description</a><ul>
<li><a class="reference internal" href="#introduction" id="id6">Introduction</a><ul>
<li><a class="reference internal" href="#formula-for-calculating-and" id="id7">Formula for calculating <span class="math">\(A(d)\)</span>, <span class="math">\(B(d)\)</span>, <span class="math">\(\sigma(d)\)</span> and <span class="math">\(\gamma(d)\)</span></a></li>
</ul>
</li>
<li><a class="reference internal" href="#break-down-the-problem" id="id8">Break down the problem</a></li>
<li><a class="reference internal" href="#current-implementation" id="id9">Current Implementation</a></li>
<li><a class="reference internal" href="#refinement-algorithm" id="id10">Refinement Algorithm</a><ul>
<li><a class="reference internal" href="#directfit" id="id11">DirectFit</a></li>
<li><a class="reference internal" href="#montecarlo" id="id12">MonteCarlo</a></li>
<li><a class="reference internal" href="#constraint" id="id13">Constraint</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use-algorithm-with-other-algorithms" id="id14">How to use algorithm with other algorithms</a></li>
</ul>
</li>
<li><a class="reference internal" href="#usage" id="id15">Usage</a></li>
<li><a class="reference internal" href="#source" id="id16">Source</a></li>
</ul>
</div>
<div class="section" id="summary">
<h2><a class="toc-backref" href="#id2">Summary</a><a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>Parameters include Dtt1, Dtt1t, Dtt2t, Zero, Zerot.</p>
<div class="section" id="see-also">
<h3><a class="toc-backref" href="#id3">See Also</a><a class="headerlink" href="#see-also" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="RefinePowderDiffProfileSeq-v1.html#algm-refinepowderdiffprofileseq"><span class="std std-ref">RefinePowderDiffProfileSeq</span></a></p>
</div>
</div>
<div class="section" id="properties">
<h2><a class="toc-backref" href="#id4">Properties</a><a class="headerlink" href="#properties" title="Permalink to this headline">¶</a></h2>
<table border="1" class="docutils">
<colgroup>
<col width="17%" />
<col width="3%" />
<col width="20%" />
<col width="7%" />
<col width="54%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Direction</th>
<th class="head">Type</th>
<th class="head">Default</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>InputPeakPositionWorkspace</td>
<td>Input</td>
<td><a class="reference internal" href="../concepts/Workspace2D.html#workspace2d"><span class="std std-ref">Workspace2D</span></a></td>
<td><em>Mandatory</em></td>
<td>Data workspace containing workspace positions in TOF agains dSpacing.</td>
</tr>
<tr class="row-odd"><td>WorkspaceIndex</td>
<td>Input</td>
<td>number</td>
<td>0</td>
<td>Workspace Index of the peak positions in PeakPositionWorkspace.</td>
</tr>
<tr class="row-even"><td>OutputPeakPositionWorkspace</td>
<td>Output</td>
<td><a class="reference internal" href="../concepts/Workspace2D.html#workspace2d"><span class="std std-ref">Workspace2D</span></a></td>
<td>&#160;</td>
<td>Output data workspace containing refined workspace positions in TOF agains dSpacing.</td>
</tr>
<tr class="row-odd"><td>InputInstrumentParameterWorkspace</td>
<td>Input</td>
<td><a class="reference internal" href="../concepts/TableWorkspaces.html#table-workspaces"><span class="std std-ref">TableWorkspace</span></a></td>
<td><em>Mandatory</em></td>
<td>INput tableWorkspace containg instrument’s parameters.</td>
</tr>
<tr class="row-even"><td>OutputInstrumentParameterWorkspace</td>
<td>Output</td>
<td><a class="reference internal" href="../concepts/TableWorkspaces.html#table-workspaces"><span class="std std-ref">TableWorkspace</span></a></td>
<td>&#160;</td>
<td>Output tableworkspace containing instrument’s fitted parameters.</td>
</tr>
<tr class="row-odd"><td>RefinementAlgorithm</td>
<td>Input</td>
<td>string</td>
<td>MonteCarlo</td>
<td>Algorithm to refine the instrument parameters. Allowed values: [‘OneStepFit’, ‘MonteCarlo’]</td>
</tr>
<tr class="row-even"><td>RandomWalkSteps</td>
<td>Input</td>
<td>number</td>
<td>10000</td>
<td>Number of Monte Carlo random walk steps.</td>
</tr>
<tr class="row-odd"><td>MonteCarloRandomSeed</td>
<td>Input</td>
<td>number</td>
<td>0</td>
<td>Random seed for Monte Carlo simulation.</td>
</tr>
<tr class="row-even"><td>StandardError</td>
<td>Input</td>
<td>string</td>
<td>ConstantValue</td>
<td>Algorithm to calculate the standard error of peak positions. Allowed values: [‘ConstantValue’, ‘UseInputValue’]</td>
</tr>
<tr class="row-odd"><td>Damping</td>
<td>Input</td>
<td>number</td>
<td>1</td>
<td>Damping factor for (1) minimizer ‘Damped Gauss-Newton’. (2) Monte Carlo.</td>
</tr>
<tr class="row-even"><td>AnnealingTemperature</td>
<td>Input</td>
<td>number</td>
<td>1</td>
<td>Starting annealing temperature.</td>
</tr>
<tr class="row-odd"><td>MonteCarloIterations</td>
<td>Input</td>
<td>number</td>
<td>100</td>
<td>Number of iterations in Monte Carlo random walk.</td>
</tr>
<tr class="row-even"><td>ChiSquare</td>
<td>Output</td>
<td>number</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="description">
<h2><a class="toc-backref" href="#id5">Description</a><a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h2>
<p>This algorithm refines the instrumental geometry parameters for powder
diffractomers. The parameters that can be refined are Dtt1, Zero, Dtt1t,
Dtt2t, Zerot, Width and Tcross.</p>
<p>It serves as the second step to fit/refine instrumental parameters that
will be introduced in Le Bail Fit. It uses the outcome from
<a class="reference internal" href="FitPowderDiffPeaks-v1.html#algm-fitpowderdiffpeaks"><span class="std std-ref">FitPowderDiffPeaks</span></a> algorithm.</p>
<div class="section" id="introduction">
<h3><a class="toc-backref" href="#id6">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h3>
<p>In order to do Rietveld refinement to experimental data, the diffractometer’s profile should be calibrated by the standards, such as LaB6 or Ni,
with known crystal structure and lattice parameters.</p>
<p>For POWGEN and NOMAD, the type of the instrument profile is back-to-back exponential function convoluted with
pseudo voigt of thermal neutron and epithermal neutron.
It means that each diffraction peak is a back-to-back exponential,</p>
<div class="math">
\[I\frac{AB}{2(A+B)}\left[ \exp \left( \frac{A[AS^2+2(x-X0)]}{2}\right) \mbox{erfc}\left( \frac{AS^2+(x-X0)}{S\sqrt{2}} \right) + \exp \left( \frac{B[BS^2-2(x-X0)]}{2} \right) \mbox{erfc} \left( \frac{[BS^2-(x-X0)]}{S\sqrt{2}} \right) \right].\]</div>
<p>with peak parameter <span class="math">\(A\)</span>, <span class="math">\(B\)</span>, <span class="math">\(X_0\)</span> and <span class="math">\(S\)</span></p>
<p>And their corresponding peak parameters are functions described as:</p>
<div class="math">
\[ \begin{align}\begin{aligned}n_{cross} = \frac{1}{2} \text{erfc}(Width(xcross\cdot d^{-1}))\\TOF_e = Zero + Dtt1\cdot d\\TOF_t = Zerot + Dtt1t\cdot d - Dtt2t \cdot d^{-1}\end{aligned}\end{align} \]</div>
<p>Final Time-of-flight is calculated as:</p>
<div class="math">
\[TOF = n_{cross} TOF_e + (1-n_{cross}) TOF_t\]</div>
<div class="section" id="formula-for-calculating-and">
<h4><a class="toc-backref" href="#id7">Formula for calculating <span class="math">\(A(d)\)</span>, <span class="math">\(B(d)\)</span>, <span class="math">\(\sigma(d)\)</span> and <span class="math">\(\gamma(d)\)</span></a><a class="headerlink" href="#formula-for-calculating-and" title="Permalink to this headline">¶</a></h4>
<p><span class="math">\(\alpha(d)\)</span>:</p>
<div class="math">
\[ \begin{align}\begin{aligned}\alpha^e(d) = \alpha_0^e + \alpha_1^e d_h\\\alpha^t(d) = \alpha_0^t - \frac{\alpha_1^t}{d_h}\\\alpha(d)   = \frac{1}{n\alpha^e + (1-n)\alpha^t}\end{aligned}\end{align} \]</div>
<p><span class="math">\(\beta(d)\)</span>:</p>
<div class="math">
\[ \begin{align}\begin{aligned}\beta^e(d) = \beta_0^e + \beta_1^e d_h\\\beta^t(d) = \beta_0^t - \frac{\beta_1^t}{d_h}\\\beta(d)   = \frac{1}{n\alpha^e + (1-n)\beta^t}\end{aligned}\end{align} \]</div>
<p>For <span class="math">\(\sigma_G\)</span> and <span class="math">\(\gamma_L\)</span>, which represent the standard deviation for pseudo-voigt</p>
<div class="math">
\[ \begin{align}\begin{aligned}\sigma_G^2(d_h) = \sigma_0^2 + (\sigma_1^2 + DST2(1-\zeta)^2)d_h^2 + (\sigma_2^2 + Gsize)d_h^4\\\gamma_L(d_h) = \gamma_0 + (\gamma_1 + \zeta\sqrt{8\ln2DST2})d_h + (\gamma_2+F(SZ))d_h^2\end{aligned}\end{align} \]</div>
<p>The analysis formula for the convoluted peak at <span class="math">\(d_h\)</span></p>
<div class="math">
\[\Omega(TOF(d_h)) = (1-\eta(d_h))N\{e^u\text{erfc}(y)+e^v\text{erfc}(z)\} - \frac{2N\eta}{\pi}\{\Im[e^pE_1(p)]+\Im[e^qE_1(q)]\}\]</div>
<p>where</p>
<div class="math">
\[ \begin{align}\begin{aligned}\text{erfc}(x) = 1-\text{erf}(x) = 1-\frac{2}{\sqrt{\pi}}\int_0^xe^{-u^2}du\\E_1(z) = \int_z^{\infty}\frac{e^{-t}}{t}dt\\u = \frac{1}{2}\alpha(d_h)(\alpha(d_h)\sigma^2(d_h)+2x)\\y = \frac{\alpha(d_h)\sigma^2(d_h)+x}{\sqrt{2\sigma^2(d_h)}}\\p = \alpha(d_h)x + \frac{i\alpha(d_h)H(d_h)}{2}\\v = \frac{1}{2}\beta(d_h)(\beta(d_h)\sigma^2(d_h)-2x)\\z = \frac{\beta(d_h)\sigma^2(d_h)-x}{\sqrt{2\sigma^2(d_h)}}\\q = -\beta(d_h)x + \frac{i\beta(d_h)H(d_h)}{2}\end{aligned}\end{align} \]</div>
<p><span class="math">\(\text{erfc}(x)\)</span> and <span class="math">\(E_1(z)\)</span> will be calculated numerically.</p>
</div>
</div>
<div class="section" id="break-down-the-problem">
<h3><a class="toc-backref" href="#id8">Break down the problem</a><a class="headerlink" href="#break-down-the-problem" title="Permalink to this headline">¶</a></h3>
<p>If we can do the single peak fitting on each single diffraction peak in a certain range,
then we can divide the optimization problem into 4 sub problems for <span class="math">\(X_0\)</span>, <span class="math">\(A\)</span>,
<span class="math">\(B\)</span> and <span class="math">\(S\)</span>, with the constraint on <span class="math">\(n\)</span>, the ratio between thermal
and epi thermal neutrons.</p>
<p>The function to fit is</p>
<p><span class="math">\(X_0\)</span>:</p>
<div class="math">
\[TOF\_h = n(Zero + Dtt1\cdot d) + (1-n)(Zerot + Dtt1t\cdot d + Dtt2t/d)\]</div>
<p><span class="math">\(A\)</span>:</p>
<div class="math">
\[\alpha(d)   = \frac{1}{n\alpha^e + (1-n)\alpha^t}\]</div>
<p><span class="math">\(B\)</span>:</p>
<div class="math">
\[\beta(d)   = \frac{1}{n\alpha^e + (1-n)\beta^t}\]</div>
<p><span class="math">\(S\)</span>:</p>
<div class="math">
\[\sigma_G^2(d_h) = \sigma_0^2 + (\sigma_1^2 + DST2(1-\zeta)^2)d_h^2 + (\sigma_2^2 + Gsize)d_h^4\]</div>
<p>with constraint:</p>
<div class="math">
\[n = 1/2 \text{erfc}(W\cdot (1-Tcross/d))\]</div>
<p>The coefficients in this function are strongly correlated to each other.</p>
</div>
<div class="section" id="current-implementation">
<h3><a class="toc-backref" href="#id9">Current Implementation</a><a class="headerlink" href="#current-implementation" title="Permalink to this headline">¶</a></h3>
<p>Only the parameters of the function for <span class="math">\(X_0\)</span> are fitted in
present implementation.</p>
</div>
<div class="section" id="refinement-algorithm">
<h3><a class="toc-backref" href="#id10">Refinement Algorithm</a><a class="headerlink" href="#refinement-algorithm" title="Permalink to this headline">¶</a></h3>
<p>Two refinement algorithms, DirectFit and MonteCarlo, are provided.</p>
<div class="section" id="directfit">
<h4><a class="toc-backref" href="#id11">DirectFit</a><a class="headerlink" href="#directfit" title="Permalink to this headline">¶</a></h4>
<p>This is a simple one step fitting. If there is one parameter to fit,
Levenberg Marquart minimizer is chosen. As its coefficients are strongly
correlated to each other, Simplex minimizer is used if there are more
than 1 parameter to fit.</p>
</div>
<div class="section" id="montecarlo">
<h4><a class="toc-backref" href="#id12">MonteCarlo</a><a class="headerlink" href="#montecarlo" title="Permalink to this headline">¶</a></h4>
<p>This adopts the concept of Monte Carlo random walk in the parameter
space. In each MC step, one parameter will be chosen, and a new value is
proposed for it. A constraint fitting by Simplex minimizer is used to
fit the coefficients in new configuration.</p>
<p>Simulated annealing will be tried as soon as it is implemented in
Mantid.</p>
</div>
<div class="section" id="constraint">
<h4><a class="toc-backref" href="#id13">Constraint</a><a class="headerlink" href="#constraint" title="Permalink to this headline">¶</a></h4>
<p>In future, constaint will be considered.</p>
</div>
</div>
<div class="section" id="how-to-use-algorithm-with-other-algorithms">
<h3><a class="toc-backref" href="#id14">How to use algorithm with other algorithms</a><a class="headerlink" href="#how-to-use-algorithm-with-other-algorithms" title="Permalink to this headline">¶</a></h3>
<p>This algorithm is designed to work with other algorithms to do Le Bail
fit. The introduction can be found in the wiki page of
<a class="reference internal" href="LeBailFit-v1.html#algm-lebailfit"><span class="std std-ref">LeBailFit v1</span></a>.</p>
</div>
</div>
<div class="section" id="usage">
<h2><a class="toc-backref" href="#id15">Usage</a><a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p><strong>Categories</strong>: <a class="reference external" href="categories/AlgorithmIndex.html">AlgorithmIndex</a> | <a class="reference external" href="categories/Diffraction/Fitting.html">Diffraction\Fitting</a></p>
</div>
<div class="section" id="source">
<h2><a class="toc-backref" href="#id16">Source</a><a class="headerlink" href="#source" title="Permalink to this headline">¶</a></h2>
<p>C++ header: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/7cec3a047fd2864c82ac0280d76fe566152576ec/Framework/CurveFitting/inc/MantidCurveFitting/Algorithms/RefinePowderInstrumentParameters3.h">RefinePowderInstrumentParameters3.h</a></p>
<p>C++ source: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/7cec3a047fd2864c82ac0280d76fe566152576ec/Framework/CurveFitting/src/Algorithms/RefinePowderInstrumentParameters3.cpp">RefinePowderInstrumentParameters3.cpp</a></p>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
      <ul class="nav navbar-nav" style=" float: right;">
      
      
          
            
  <li>
    <a href="RefinePowderDiffProfileSeq-v1.html" title="Previous Chapter: RefinePowderDiffProfileSeq v1"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; RefinePowderD...</span>
    </a>
  </li>
  <li>
    <a href="ReflectometryBackgroundSubtraction-v1.html" title="Next Chapter: ReflectometryBackgroundSubtraction v1"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Reflectometry... &raquo;</span>
    </a>
  </li>
          
       
          <li><a href="#">Back to top</a></li>
       </ul>
    <p>
    </p>
  </div>
</footer>
  </body>
</html>