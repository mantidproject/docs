<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>FindGlobalBMatrix v1</title>
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.3.6/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.3.6/css/bootstrap-theme.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '6.4.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="FindGoniometerFromUB v1" href="FindGoniometerFromUB-v1.html" />
    <link rel="prev" title="FindEPP v2" href="FindEPP-v2.html" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59110517-1', 'auto');
  ga('send', 'pageview');

</script>


  </head>
  <body>





  <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://www.mantidproject.org"><img src="../_static/Mantid_Logo_Transparent.png">
           </a>
        <span class="navbar-text navbar-version pull-left"><b>6.4</b></span>
      </div>

      
        <div class="collapse navbar-collapse nav-collapse">
      
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
                <li><a href="http://www.mantidproject.org">Home</a></li>
                <li><a href="http://download.mantidproject.org">Download</a></li>
                <li><a href="http://docs.mantidproject.org/nightly/">Documentation</a></li>
                <li><a href="http://www.mantidproject.org/Contact">Contact Us</a></li>
            
            
              
              
            
            
            
            
          </ul>
              
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
            </div>
    </div>
    <p>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="../index.html">Documentation</a> &#187;</li>
        
            <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Algorithms</a> &#187;</li>
          
        
        
          
            <li class="nav-item nav-item-this"><a href="">FindGlobalBMatrix v1</a></li>
          
        
      </ul>
    </div> </p>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <p><span class="math">\(\renewcommand\AA{\unicode{x212B}}\)</span></p>
<div class="section" id="findglobalbmatrix-v1">
<span id="algm-findglobalbmatrix"></span><span id="algm-findglobalbmatrix-v1"></span><h1>FindGlobalBMatrix v1<a class="headerlink" href="#findglobalbmatrix-v1" title="Permalink to this headline">¶</a></h1>
<div class="figure align-right" id="id1">
<span id="index-0"></span><a class="screenshot reference internal image-reference" href="../_images/FindGlobalBMatrix-v1_dlg.png"><img alt="../_images/FindGlobalBMatrix-v1_dlg.png" class="screenshot" src="../_images/FindGlobalBMatrix-v1_dlg.png" style="width: 300px;" /></a>
<p class="caption"><span class="caption-text"><strong>FindGlobalBMatrix</strong> dialog.</span></p>
</div>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#summary" id="id2">Summary</a><ul>
<li><a class="reference internal" href="#see-also" id="id3">See Also</a></li>
</ul>
</li>
<li><a class="reference internal" href="#properties" id="id4">Properties</a></li>
<li><a class="reference internal" href="#description" id="id5">Description</a></li>
<li><a class="reference internal" href="#useage" id="id6">Useage</a></li>
<li><a class="reference internal" href="#source" id="id7">Source</a></li>
</ul>
</div>
<div class="section" id="summary">
<h2><a class="toc-backref" href="#id2">Summary</a><a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>Takes multiple peak tables from different runs and refines common lattice parameters and angles.</p>
<div class="section" id="see-also">
<h3><a class="toc-backref" href="#id3">See Also</a><a class="headerlink" href="#see-also" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="FindUBUsingLatticeParameters-v1.html#algm-findubusinglatticeparameters"><span class="std std-ref">FindUBUsingLatticeParameters</span></a>, <a class="reference internal" href="CalculateUMatrix-v1.html#algm-calculateumatrix"><span class="std std-ref">CalculateUMatrix</span></a></p>
</div>
</div>
<div class="section" id="properties">
<h2><a class="toc-backref" href="#id4">Properties</a><a class="headerlink" href="#properties" title="Permalink to this headline">¶</a></h2>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="4%" />
<col width="6%" />
<col width="8%" />
<col width="73%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Direction</th>
<th class="head">Type</th>
<th class="head">Default</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>PeakWorkspaces</td>
<td>Input</td>
<td>str list</td>
<td><em>Mandatory</em></td>
<td>List of peak workspaces to use (must be more than two peaks workspaces and each must contain at least 6 peaks.</td>
</tr>
<tr class="row-odd"><td>a</td>
<td>Input</td>
<td>number</td>
<td><em>Mandatory</em></td>
<td>Lattice parameter a</td>
</tr>
<tr class="row-even"><td>b</td>
<td>Input</td>
<td>number</td>
<td><em>Mandatory</em></td>
<td>Lattice parameter b</td>
</tr>
<tr class="row-odd"><td>c</td>
<td>Input</td>
<td>number</td>
<td><em>Mandatory</em></td>
<td>Lattice parameter c</td>
</tr>
<tr class="row-even"><td>alpha</td>
<td>Input</td>
<td>number</td>
<td><em>Mandatory</em></td>
<td>Lattice angle alpha</td>
</tr>
<tr class="row-odd"><td>beta</td>
<td>Input</td>
<td>number</td>
<td><em>Mandatory</em></td>
<td>Lattice angle beta</td>
</tr>
<tr class="row-even"><td>gamma</td>
<td>Input</td>
<td>number</td>
<td><em>Mandatory</em></td>
<td>Lattice angle gamma</td>
</tr>
<tr class="row-odd"><td>Tolerance</td>
<td>Input</td>
<td>number</td>
<td>0.15</td>
<td>Tolerance to index peaks in in H,K and L</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="description">
<h2><a class="toc-backref" href="#id5">Description</a><a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h2>
<p>FindGlobalBMatrix refines the lattice parameters (encoded in the B matrix) across PeaksWorkspaces from multiple runs
with a separate U matrix (which encodes the orientation for an identity goniometer matrix) per run. This is useful for
when the goniometer matrix is inaccurate/not well known.</p>
<p>The quantity minimised is the average of the square of the difference in QSample between the observed peak and the peak
at integer HKL (see <a class="reference internal" href="CalculateUMatrix-v1.html#algm-calculateumatrix"><span class="std std-ref">CalculateUMatrix v1</span></a> for details). The average rather than the sum of the squared residuals
is used so as not to penalise the indexing of more peaks as the UB matrix becomes more accurate.</p>
<p>FindGlobalBMatrix adds a different UB to each peak workspace that can be indexed - note the algorithm ensures consistent
indexing across all runs (i.e. axes are not swapped or inverted). All peaks workspaces must have more then 6 peaks in
(a requirement of some child algorithms used).</p>
<p>The algorithm proceeds in this way:</p>
<ul class="simple">
<li>Finds an initial UB<ul>
<li>If a UB exists on any workspace the initial is the UB that indexes the most peaks.</li>
<li>Otherwise <a class="reference internal" href="FindUBUsingLatticeParameters-v1.html#algm-findubusinglatticeparameters"><span class="std std-ref">FindUBUsingLatticeParameters</span></a> is run on the workspaces with the input lattice parameters until a UB is found.</li>
</ul>
</li>
<li>Peaks in all workspaces are indexed consistently with the initial UB<ul>
<li>If a workspace has a valid UB it is transformed to preserve consistent indexing.</li>
<li>Otherwise we try to index the peaks using the initial UB and the goniometer matrix on the workspace</li>
<li>If the above doesn’t work because e.g. the goniometer matrix is inaccurate, we find a UB using <a class="reference internal" href="FindUBUsingLatticeParameters-v1.html#algm-findubusinglatticeparameters"><span class="std std-ref">FindUBUsingLatticeParameters</span></a> and transform to preserve consistent indexing.</li>
</ul>
</li>
<li>Once peaks are indexed the optimal lattice parameters are found that minimise the average of the squared residuals in QSample across all runs.<ul>
<li>The U matrix of each run is found for a given set of lattice parameters using <a class="reference internal" href="CalculateUMatrix-v1.html#algm-calculateumatrix"><span class="std std-ref">CalculateUMatrix v1</span></a>.</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="useage">
<h2><a class="toc-backref" href="#id6">Useage</a><a class="headerlink" href="#useage" title="Permalink to this headline">¶</a></h2>
<p><strong>Example:</strong></p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mantid.simpleapi</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># load empty instrument so can create a peak table</span>
<span class="n">ws</span> <span class="o">=</span> <span class="n">LoadEmptyInstrument</span><span class="p">(</span><span class="n">InstrumentName</span><span class="o">=</span><span class="s1">&#39;SXD&#39;</span><span class="p">,</span> <span class="n">OutputWorkspace</span><span class="o">=</span><span class="s1">&#39;empty_SXD&#39;</span><span class="p">)</span>
<span class="n">axis</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">axis</span><span class="o">.</span><span class="n">setUnit</span><span class="p">(</span><span class="s2">&quot;TOF&quot;</span><span class="p">)</span>

<span class="c1"># create two peak tables with UB corresponding to different lattice constants, a</span>
<span class="n">peaks1</span> <span class="o">=</span> <span class="n">CreatePeaksWorkspace</span><span class="p">(</span><span class="n">InstrumentWorkspace</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span> <span class="n">NumberOfPeaks</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">UB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">3.8</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>  <span class="c1"># alatt = [3.8, 4, 10]</span>
<span class="n">SetUB</span><span class="p">(</span><span class="n">peaks1</span><span class="p">,</span> <span class="n">UB</span><span class="o">=</span><span class="n">UB</span><span class="p">)</span>
<span class="n">peaks2</span> <span class="o">=</span> <span class="n">CreatePeaksWorkspace</span><span class="p">(</span><span class="n">InstrumentWorkspace</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span> <span class="n">NumberOfPeaks</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">UB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">4.2</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>  <span class="c1"># alatt = [4.2, 4, 10]</span>
<span class="n">SetUB</span><span class="p">(</span><span class="n">peaks2</span><span class="p">,</span> <span class="n">UB</span><span class="o">=</span><span class="n">UB</span><span class="p">)</span>
<span class="c1"># Add some peaks</span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">peaks</span> <span class="ow">in</span> <span class="p">[</span><span class="n">peaks1</span><span class="p">,</span> <span class="n">peaks2</span><span class="p">]:</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">createPeakHKL</span><span class="p">([</span><span class="n">h</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
            <span class="n">peaks</span><span class="o">.</span><span class="n">addPeak</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>

<span class="n">FindGlobalBMatrix</span><span class="p">(</span><span class="n">PeakWorkspaces</span><span class="o">=</span><span class="p">[</span><span class="n">peaks1</span><span class="p">,</span> <span class="n">peaks2</span><span class="p">],</span> <span class="n">a</span><span class="o">=</span><span class="mf">4.1</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mf">4.2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">88</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">88</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mi">89</span><span class="p">,</span>
                  <span class="n">Tolerance</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>

<span class="c1"># show that both workspaces have the average of the two a lattice constants (a=4 Ang)</span>
<span class="k">print</span><span class="p">(</span><span class="n">peaks1</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">getOrientedLattice</span><span class="p">())</span>
<span class="c1"># lattice parameters: a = 4.00025 b = 3.98794 c = 9.99608 alpha = 89.9698 beta = 90.0829 gamma = 89.9336</span>

<span class="k">print</span><span class="p">(</span><span class="n">peaks2</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">getOrientedLattice</span><span class="p">())</span>
<span class="c1"># lattice parameters: a = 4.00025 b = 3.98794 c = 9.99608 alpha = 89.9698 beta = 90.0829 gamma = 89.9336</span>
</pre></div>
</div>
<p><strong>Categories</strong>: <a class="reference external" href="categories/AlgorithmIndex.html">AlgorithmIndex</a> | <a class="reference external" href="categories/Diffraction/Reduction.html">Diffraction\Reduction</a></p>
</div>
<div class="section" id="source">
<h2><a class="toc-backref" href="#id7">Source</a><a class="headerlink" href="#source" title="Permalink to this headline">¶</a></h2>
<p>Python: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/7cec3a047fd2864c82ac0280d76fe566152576ec/Framework/PythonInterface/plugins/algorithms/FindGlobalBMatrix.py">FindGlobalBMatrix.py</a></p>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
      <ul class="nav navbar-nav" style=" float: right;">
      
      
          
            
  <li>
    <a href="FindEPP-v2.html" title="Previous Chapter: FindEPP v2"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; FindEPP v2</span>
    </a>
  </li>
  <li>
    <a href="FindGoniometerFromUB-v1.html" title="Next Chapter: FindGoniometerFromUB v1"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">FindGoniomete... &raquo;</span>
    </a>
  </li>
          
       
          <li><a href="#">Back to top</a></li>
       </ul>
    <p>
    </p>
  </div>
</footer>
  </body>
</html>