<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>HFIRCalculateGoniometer v1</title>
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.3.6/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.3.6/css/bootstrap-theme.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '6.4.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="HFIRDarkCurrentSubtraction v1" href="HFIRDarkCurrentSubtraction-v1.html" />
    <link rel="prev" title="HB3APredictPeaks v1" href="HB3APredictPeaks-v1.html" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59110517-1', 'auto');
  ga('send', 'pageview');

</script>


  </head>
  <body>





  <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://www.mantidproject.org"><img src="../_static/Mantid_Logo_Transparent.png">
           </a>
        <span class="navbar-text navbar-version pull-left"><b>6.4</b></span>
      </div>

      
        <div class="collapse navbar-collapse nav-collapse">
      
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
                <li><a href="http://www.mantidproject.org">Home</a></li>
                <li><a href="http://download.mantidproject.org">Download</a></li>
                <li><a href="http://docs.mantidproject.org/nightly/">Documentation</a></li>
                <li><a href="http://www.mantidproject.org/Contact">Contact Us</a></li>
            
            
              
              
            
            
            
            
          </ul>
              
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
            </div>
    </div>
    <p>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="../index.html">Documentation</a> &#187;</li>
        
            <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Algorithms</a> &#187;</li>
          
        
        
          
            <li class="nav-item nav-item-this"><a href="">HFIRCalculateGoniometer v1</a></li>
          
        
      </ul>
    </div> </p>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <p><span class="math">\(\renewcommand\AA{\unicode{x212B}}\)</span></p>
<div class="section" id="hfircalculategoniometer-v1">
<span id="algm-hfircalculategoniometer"></span><span id="algm-hfircalculategoniometer-v1"></span><h1>HFIRCalculateGoniometer v1<a class="headerlink" href="#hfircalculategoniometer-v1" title="Permalink to this headline">¶</a></h1>
<div class="figure align-right" id="id1">
<span id="index-0"></span><a class="screenshot reference internal image-reference" href="../_images/HFIRCalculateGoniometer-v1_dlg.png"><img alt="../_images/HFIRCalculateGoniometer-v1_dlg.png" class="screenshot" src="../_images/HFIRCalculateGoniometer-v1_dlg.png" style="width: 388px;" /></a>
<p class="caption"><span class="caption-text"><strong>HFIRCalculateGoniometer</strong> dialog.</span></p>
</div>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#summary" id="id2">Summary</a><ul>
<li><a class="reference internal" href="#see-also" id="id3">See Also</a></li>
</ul>
</li>
<li><a class="reference internal" href="#properties" id="id4">Properties</a></li>
<li><a class="reference internal" href="#description" id="id5">Description</a></li>
<li><a class="reference internal" href="#usage" id="id6">Usage</a></li>
<li><a class="reference internal" href="#source" id="id7">Source</a></li>
</ul>
</div>
<div class="section" id="summary">
<h2><a class="toc-backref" href="#id2">Summary</a><a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>Calculate the goniometer for peak making an assumption for constant wavelength and goniometer rotation axes</p>
<div class="section" id="see-also">
<h3><a class="toc-backref" href="#id3">See Also</a><a class="headerlink" href="#see-also" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="FindPeaksMD-v1.html#algm-findpeaksmd"><span class="std std-ref">FindPeaksMD</span></a>, <a class="reference internal" href="PredictPeaks-v1.html#algm-predictpeaks"><span class="std std-ref">PredictPeaks</span></a>, <a class="reference internal" href="SetGoniometer-v1.html#algm-setgoniometer"><span class="std std-ref">SetGoniometer</span></a></p>
</div>
</div>
<div class="section" id="properties">
<h2><a class="toc-backref" href="#id4">Properties</a><a class="headerlink" href="#properties" title="Permalink to this headline">¶</a></h2>
<table border="1" class="docutils">
<colgroup>
<col width="9%" />
<col width="3%" />
<col width="9%" />
<col width="6%" />
<col width="73%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Direction</th>
<th class="head">Type</th>
<th class="head">Default</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Workspace</td>
<td>InOut</td>
<td>IPeaksWorkspace</td>
<td><em>Mandatory</em></td>
<td>Peaks Workspace to be modified</td>
</tr>
<tr class="row-odd"><td>Wavelength</td>
<td>Input</td>
<td>number</td>
<td><em>Optional</em></td>
<td>Wavelength to set the workspace, will be the value set on workspace if not provided.</td>
</tr>
<tr class="row-even"><td>OverrideProperty</td>
<td>Input</td>
<td>boolean</td>
<td>False</td>
<td>If False then the value for InnerGoniometer and FlipX will be determiend from the workspace, it True then the properties will be used</td>
</tr>
<tr class="row-odd"><td>InnerGoniometer</td>
<td>Input</td>
<td>boolean</td>
<td>False</td>
<td>Whether the goniometer to be calculated is the most inner (phi) or most outer (omega)</td>
</tr>
<tr class="row-even"><td>FlipX</td>
<td>Input</td>
<td>boolean</td>
<td>False</td>
<td>Used when calculating goniometer angle if the q_lab x value should be negative, hence the detector of the other side (right) of the beam</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="description">
<h2><a class="toc-backref" href="#id5">Description</a><a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h2>
<p>This algorithm calculates the goniometer of peaks from the q_sample
and wavelength. It makes use of the
<a class="reference internal" href="../api/python/mantid/geometry/Goniometer.html#mantid.geometry.Goniometer.calcFromQSampleAndWavelength" title="mantid.geometry.Goniometer.calcFromQSampleAndWavelength"><code class="xref py py-meth docutils literal"><span class="pre">mantid.geometry.Goniometer.calcFromQSampleAndWavelength()</span></code></a>
method. It was created to work with WAND² (HB2C) and DEMAND (HB3A) at
HFIR but may be applied to other constant wavelength instruments.</p>
<p>The wavelength will be read from the workspace property <cite>wavelength</cite>
unless one is provided as input. The peaks with have their wavelength
set to this value.</p>
<p>The goniometer is calculated by the following method. It only works
for a constant wavelength source. It also assumes the goniometer
rotation is around the y-axis only.</p>
<p>You can specify if the goniometer to calculated is omega or phi, outer
or inner respectively, by setting the option InnerGoniometer. The
existing goniometer on the workspace will be used as the starting
goniometer allowing only the scanning goniometer to be
calculated. This won’t change anything for HB2C as they only have an
omega axis but for HB3A you need to make sure that the goniometer is
correctly set from the logs with <cite>SetGoniometer(Workspace=scan,
Axis0=’omega,0,1,0,-1’, Axis1=’chi,0,0,1,-1’, Axis2=’phi,0,1,0,-1’)</cite>
and that you can only process peak workspaces containing peaks from a
single scan at a time.</p>
<p>The goniometer (<span class="math">\(G\)</span>) is calculated from
<span class="math">\(\textbf{Q}_{sample}\)</span> for a given wavelength (<span class="math">\(\lambda\)</span>)
by:</p>
<p>First calculate the <span class="math">\(\textbf{Q}_{lab}\)</span> using
<span class="math">\(\textbf{Q}_{sample}\)</span> and <span class="math">\(\lambda\)</span>.</p>
<div class="math">
\[k = \frac{2 \pi}{\lambda}\]</div>
<div class="math">
\[\begin{split}G \textbf{Q}_{sample} = \textbf{Q}_{lab} = \left(\begin{array}{c}
-k\sin(\theta)\cos(\phi) \\
-k\sin(\theta)\sin(\phi) \\
k (1-\cos(\theta))
\end{array}\right) (1)\end{split}\]</div>
<div class="math">
\[|\textbf{Q}_{sample}|^2 = |\textbf{Q}_{lab}|^2 = 2 k^2 (1-\cos(\theta))\]</div>
<p><span class="math">\(\therefore\)</span></p>
<div class="math">
\[\theta = \cos^{-1}(1-\frac{|\textbf{Q}_{sample}|^2}{2k^2})\]</div>
<div class="math">
\[\phi = \sin^{-1}(-\frac{\textbf{Q}_{sample}^y}{k \sin(\theta)})\]</div>
<p>where <span class="math">\(\theta\)</span> is from 0 to <span class="math">\(\pi\)</span> and <span class="math">\(\phi\)</span> is from
<span class="math">\(-\pi/2\)</span> to <span class="math">\(\pi/2\)</span>. This means that it will assume your
detector position is on the left of the beam even if it’s not, unless
the option FlipX is set to True then the <span class="math">\(\textbf{Q}_{lab}^x = -\textbf{Q}_{lab}^x\)</span>.</p>
<p>Now you have <span class="math">\(\theta\)</span>, <span class="math">\(\phi\)</span> and k you can get <span class="math">\(\textbf{Q}_{lab}\)</span> using (1).</p>
<p>We need to now solve <span class="math">\(G \textbf{Q}_{sample} =
\textbf{Q}_{lab}\)</span>. For a rotation around y-axis only we want to find
<span class="math">\(\psi\)</span> for:</p>
<div class="math">
\[\begin{split}G = \begin{bmatrix}
\cos(\psi)  &amp; 0 &amp; \sin(\psi) \\
0           &amp; 1 &amp; 0 \\
-\sin(\psi) &amp; 0 &amp; \cos(\psi)
\end{bmatrix} (2)\end{split}\]</div>
<p>which gives two equations</p>
<div class="math">
\[\cos(\psi)\textbf{Q}_{sample}^x+\sin(\psi)\textbf{Q}_{sample}^z = \textbf{Q}_{lab}^x\]</div>
<div class="math">
\[-\sin(\psi)\textbf{Q}_{sample}^x+\cos(\psi)\textbf{Q}_{sample}^z = \textbf{Q}_{lab}^z\]</div>
<p>make</p>
<div class="math">
\[\begin{split}A = \begin{bmatrix}
\textbf{Q}_{sample}^x &amp; \textbf{Q}_{sample}^z \\
\textbf{Q}_{sample}^z &amp; -\textbf{Q}_{sample}^x
\end{bmatrix}\end{split}\]</div>
<div class="math">
\[\begin{split}B = \begin{bmatrix}
\textbf{Q}_{lab}^x \\
\textbf{Q}_{lab}^z
\end{bmatrix}\end{split}\]</div>
<p>Then we need to solve <span class="math">\(A X = B\)</span> for <span class="math">\(X\)</span> where</p>
<div class="math">
\[\begin{split}X = \begin{bmatrix}
\cos{\psi} \\
\sin{\psi}
\end{bmatrix} = A^{-1} B\end{split}\]</div>
<p>then</p>
<div class="math">
\[\psi = \tan^{-1}\left(\frac{\sin{\psi}}{\cos{\psi}}\right)\]</div>
<p>Put <span class="math">\(\psi\)</span> into (2) and you have the goniometer for that peak.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If the instrument is HB3A and the <cite>InnerGoniometer</cite> and <cite>FlipX</cite>
properties are left empty then these values will be set correctly
automatically.</p>
</div>
</div>
<div class="section" id="usage">
<h2><a class="toc-backref" href="#id6">Usage</a><a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p><strong>Example: omega calculation</strong></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">peaks</span> <span class="o">=</span> <span class="n">CreatePeaksWorkspace</span><span class="p">(</span><span class="n">OutputType</span><span class="o">=</span><span class="s2">&quot;LeanElasticPeak&quot;</span><span class="p">,</span> <span class="n">NumberOfPeaks</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">peaks</span><span class="o">.</span><span class="n">addPeak</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">createPeakQSample</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">]))</span>   <span class="c1"># omega = -90</span>
<span class="n">peaks</span><span class="o">.</span><span class="n">addPeak</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">createPeakQSample</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>                <span class="c1"># omega = -60</span>
<span class="n">peaks</span><span class="o">.</span><span class="n">addPeak</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">createPeakQSample</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">]))</span>  <span class="c1"># omega = -30</span>
<span class="n">peaks</span><span class="o">.</span><span class="n">addPeak</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">createPeakQSample</span><span class="p">([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]))</span>  <span class="c1"># omega = 0</span>
<span class="n">peaks</span><span class="o">.</span><span class="n">addPeak</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">createPeakQSample</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>               <span class="c1"># omega = 30</span>
<span class="n">peaks</span><span class="o">.</span><span class="n">addPeak</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">createPeakQSample</span><span class="p">([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">]))</span> <span class="c1"># omega = 60</span>
<span class="n">peaks</span><span class="o">.</span><span class="n">addPeak</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">createPeakQSample</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">]))</span> <span class="c1"># omega = 90</span>
<span class="n">HFIRCalculateGoniometer</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">Goniometer</span><span class="p">()</span>
    <span class="n">g</span><span class="o">.</span><span class="n">setR</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">getPeak</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">getGoniometerMatrix</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Peak </span><span class="si">{n}</span><span class="s2"> - omega = {g.getEulerAngles(&#39;YZY&#39;)[0]:.1f}&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>Peak 0 - omega = -90.0
Peak 1 - omega = -60.0
Peak 2 - omega = -30.0
Peak 3 - omega = 0.0
Peak 4 - omega = 30.0
Peak 5 - omega = 60.0
Peak 6 - omega = 90.0
</pre></div>
</div>
<p><strong>Categories</strong>: <a class="reference external" href="categories/AlgorithmIndex.html">AlgorithmIndex</a> | <a class="reference external" href="categories/Diffraction/Reduction.html">Diffraction\Reduction</a></p>
</div>
<div class="section" id="source">
<h2><a class="toc-backref" href="#id7">Source</a><a class="headerlink" href="#source" title="Permalink to this headline">¶</a></h2>
<p>Python: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/7cec3a047fd2864c82ac0280d76fe566152576ec/Framework/PythonInterface/plugins/algorithms/HFIRCalculateGoniometer.py">HFIRCalculateGoniometer.py</a></p>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
      <ul class="nav navbar-nav" style=" float: right;">
      
      
          
            
  <li>
    <a href="HB3APredictPeaks-v1.html" title="Previous Chapter: HB3APredictPeaks v1"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; HB3APredictPeaks v1</span>
    </a>
  </li>
  <li>
    <a href="HFIRDarkCurrentSubtraction-v1.html" title="Next Chapter: HFIRDarkCurrentSubtraction v1"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">HFIRDarkCurre... &raquo;</span>
    </a>
  </li>
          
       
          <li><a href="#">Back to top</a></li>
       </ul>
    <p>
    </p>
  </div>
</footer>
  </body>
</html>