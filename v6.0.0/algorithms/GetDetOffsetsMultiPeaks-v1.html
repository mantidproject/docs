<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>GetDetOffsetsMultiPeaks v1</title>
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.3.6/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.3.6/css/bootstrap-theme.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '6.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="GetDetectorOffsets v1" href="GetDetectorOffsets-v1.html" />
    <link rel="prev" title="GetAllEi v1" href="GetAllEi-v1.html" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59110517-1', 'auto');
  ga('send', 'pageview');

</script>


  </head>
  <body>





  <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://www.mantidproject.org"><img src="../_static/Mantid_Logo_Transparent.png">
           </a>
        <span class="navbar-text navbar-version pull-left"><b>6.0</b></span>
      </div>

      
        <div class="collapse navbar-collapse nav-collapse">
      
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
                <li><a href="http://www.mantidproject.org">Home</a></li>
                <li><a href="http://download.mantidproject.org">Download</a></li>
                <li><a href="http://docs.mantidproject.org/nightly/">Documentation</a></li>
                <li><a href="http://www.mantidproject.org/Contact">Contact Us</a></li>
            
            
              
              
            
            
            
            
          </ul>
              
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
            </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <p><span class="math">\(\renewcommand\AA{\unicode{x212B}}\)</span></p>
<div class="section" id="getdetoffsetsmultipeaks-v1">
<span id="algm-getdetoffsetsmultipeaks"></span><span id="algm-getdetoffsetsmultipeaks-v1"></span><h1>GetDetOffsetsMultiPeaks v1<a class="headerlink" href="#getdetoffsetsmultipeaks-v1" title="Permalink to this headline">¶</a></h1>
<div class="figure align-right" id="id1">
<span id="index-0"></span><a class="screenshot reference internal image-reference" href="../_images/GetDetOffsetsMultiPeaks-v1_dlg.png"><img alt="../_images/GetDetOffsetsMultiPeaks-v1_dlg.png" class="screenshot" src="../_images/GetDetOffsetsMultiPeaks-v1_dlg.png" style="width: 349px;" /></a>
<p class="caption"><span class="caption-text"><strong>GetDetOffsetsMultiPeaks</strong> dialog.</span></p>
</div>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#summary" id="id2">Summary</a><ul>
<li><a class="reference internal" href="#see-also" id="id3">See Also</a></li>
</ul>
</li>
<li><a class="reference internal" href="#properties" id="id4">Properties</a></li>
<li><a class="reference internal" href="#description" id="id5">Description</a><ul>
<li><a class="reference internal" href="#fit-for-peak-offset" id="id6">Fit for peak offset</a></li>
<li><a class="reference internal" href="#criteria-on-peaks" id="id7">Criteria on peaks</a></li>
<li><a class="reference internal" href="#generate-fit-window" id="id8">Generate fit window</a><ul>
<li><a class="reference internal" href="#uniform-fit-window" id="id9">Uniform fit window</a></li>
<li><a class="reference internal" href="#fit-window-for-individual-peak" id="id10">Fit window for individual peak</a><ul>
<li><a class="reference internal" href="#default-fit-windows" id="id11">Default fit windows</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#quality-of-fitting" id="id12">Quality of Fitting</a><ul>
<li><a class="reference internal" href="#number-of-spectra-that-are-not-masked" id="id13">Number of spectra that are NOT masked</a></li>
<li><a class="reference internal" href="#of-the-offset-fitting-function" id="id14"><span class="math">\(\chi^2\)</span> of the offset fitting function</a></li>
<li><a class="reference internal" href="#deviation-of-highest-peaks" id="id15">Deviation of highest peaks</a></li>
<li><a class="reference internal" href="#collective-quantities-to-illustrate-goodness-of-fitting-still-in-development" id="id16">Collective quantities to illustrate goodness of fitting (still in development)</a></li>
<li><a class="reference internal" href="#standard-error-on-offset" id="id17">Standard error on offset</a></li>
</ul>
</li>
<li><a class="reference internal" href="#spectra-to-be-masked" id="id18">Spectra to be masked</a></li>
<li><a class="reference internal" href="#usage" id="id19">Usage</a><ul>
<li><a class="reference internal" href="#output" id="id20">Output</a></li>
</ul>
</li>
<li><a class="reference internal" href="#source" id="id21">Source</a></li>
</ul>
</div>
<div class="section" id="summary">
<h2><a class="toc-backref" href="#id2">Summary</a><a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>Creates an OffsetsWorkspace containing offsets for each detector. You can then save these to a .cal file using SaveCalFile.</p>
<div class="section" id="see-also">
<h3><a class="toc-backref" href="#id3">See Also</a><a class="headerlink" href="#see-also" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="GetDetectorOffsets-v1.html#algm-getdetectoroffsets"><span class="std std-ref">GetDetectorOffsets</span></a></p>
</div>
</div>
<div class="section" id="properties">
<h2><a class="toc-backref" href="#id4">Properties</a><a class="headerlink" href="#properties" title="Permalink to this headline">¶</a></h2>
<table border="1" class="docutils">
<colgroup>
<col width="8%" />
<col width="2%" />
<col width="11%" />
<col width="6%" />
<col width="74%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Direction</th>
<th class="head">Type</th>
<th class="head">Default</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>InputWorkspace</td>
<td>Input</td>
<td><a class="reference internal" href="../concepts/MatrixWorkspace.html#matrixworkspace"><span class="std std-ref">MatrixWorkspace</span></a></td>
<td><em>Mandatory</em></td>
<td>A 2D matrix workspace with X values of d-spacing</td>
</tr>
<tr class="row-odd"><td>DReference</td>
<td>Input</td>
<td>dbl list</td>
<td>&#160;</td>
<td>Enter a comma-separated list of the expected X-position of the centre of the peaks. Only peaks near these positions will be fitted.</td>
</tr>
<tr class="row-even"><td>FitWindowMaxWidth</td>
<td>Input</td>
<td>number</td>
<td>0</td>
<td>Optional: The maximum width of the fitting window. If this is &lt;=0 the window is not specified to FindPeaks</td>
</tr>
<tr class="row-odd"><td>FitwindowTableWorkspace</td>
<td>Input</td>
<td><a class="reference internal" href="../concepts/TableWorkspaces.html#table-workspaces"><span class="std std-ref">TableWorkspace</span></a></td>
<td>&#160;</td>
<td>Name of the input Tableworkspace containing peak fit window information for each spectrum.</td>
</tr>
<tr class="row-even"><td>PeakFunction</td>
<td>Input</td>
<td>string</td>
<td>Gaussian</td>
<td>Type of peak to fit. Allowed values: [‘BackToBackExponential’, ‘Bk2BkExpConvPV’, ‘DeltaFunction’, ‘ElasticDiffRotDiscreteCircle’, ‘ElasticDiffSphere’, ‘ElasticIsoRotDiff’, ‘ExamplePeakFunction’, ‘Gaussian’, ‘IkedaCarpenterPV’, ‘Lorentzian’, ‘PseudoVoigt’, ‘Voigt’]</td>
</tr>
<tr class="row-odd"><td>BackgroundType</td>
<td>Input</td>
<td>string</td>
<td>Linear</td>
<td>Type of Background. The choice can be either Linear or Quadratic. Allowed values: [‘Flat’, ‘Linear’, ‘Quadratic’]</td>
</tr>
<tr class="row-even"><td>HighBackground</td>
<td>Input</td>
<td>boolean</td>
<td>True</td>
<td>Relatively weak peak in high background</td>
</tr>
<tr class="row-odd"><td>GroupingFileName</td>
<td>Input</td>
<td>string</td>
<td>&#160;</td>
<td>Optional: The name of the output CalFile to save the generated OffsetsWorkspace. Allowed extensions: [‘.cal’]</td>
</tr>
<tr class="row-even"><td>OutputWorkspace</td>
<td>Output</td>
<td>OffsetsWorkspace</td>
<td>&#160;</td>
<td>An output workspace containing the offsets.</td>
</tr>
<tr class="row-odd"><td>NumberPeaksWorkspace</td>
<td>Output</td>
<td>OffsetsWorkspace</td>
<td>&#160;</td>
<td>An output workspace containing the offsets.</td>
</tr>
<tr class="row-even"><td>MaskWorkspace</td>
<td>Output</td>
<td><a class="reference internal" href="../concepts/MatrixWorkspace.html#matrixworkspace"><span class="std std-ref">MatrixWorkspace</span></a></td>
<td>Mask</td>
<td>An output workspace containing the mask.</td>
</tr>
<tr class="row-odd"><td>MaxOffset</td>
<td>Input</td>
<td>number</td>
<td>1</td>
<td>Maximum absolute value of offsets; default is 1</td>
</tr>
<tr class="row-even"><td>MaxChiSq</td>
<td>Input</td>
<td>number</td>
<td>100</td>
<td>Maximum chisq value for individual peak fit allowed. (Default: 100)</td>
</tr>
<tr class="row-odd"><td>MinimumPeakHeight</td>
<td>Input</td>
<td>number</td>
<td>2</td>
<td>Minimum value allowed for peak height.</td>
</tr>
<tr class="row-even"><td>MinimumPeakHeightObs</td>
<td>Input</td>
<td>number</td>
<td>0</td>
<td>Least value of the maximum observed Y value of a peak within specified region.  If any peak’s maximum observed Y value is smaller, then this peak will not be fit.  It is designed for EventWorkspace with integer counts.</td>
</tr>
<tr class="row-odd"><td>Minimizer</td>
<td>Input</td>
<td>string</td>
<td>Levenberg-MarquardtMD</td>
<td>Minimizer to use for fitting peaks. Allowed values: [‘BFGS’, ‘Conjugate gradient (Fletcher-Reeves imp.)’, ‘Conjugate gradient (Polak-Ribiere imp.)’, ‘Damped GaussNewton’, ‘FABADA’, ‘Levenberg-Marquardt’, ‘Levenberg-MarquardtMD’, ‘Simplex’, ‘SteepestDescent’, ‘Trust Region’]</td>
</tr>
<tr class="row-even"><td>InputResolutionWorkspace</td>
<td>Input</td>
<td><a class="reference internal" href="../concepts/MatrixWorkspace.html#matrixworkspace"><span class="std std-ref">MatrixWorkspace</span></a></td>
<td>&#160;</td>
<td>Name of the optional input resolution (delta(d)/d) workspace.</td>
</tr>
<tr class="row-odd"><td>SpectraFitInfoTableWorkspace</td>
<td>Output</td>
<td><a class="reference internal" href="../concepts/TableWorkspaces.html#table-workspaces"><span class="std std-ref">TableWorkspace</span></a></td>
<td>&#160;</td>
<td>Name of the output table workspace containing spectra peak fit information.</td>
</tr>
<tr class="row-even"><td>PeaksOffsetTableWorkspace</td>
<td>Output</td>
<td><a class="reference internal" href="../concepts/TableWorkspaces.html#table-workspaces"><span class="std std-ref">TableWorkspace</span></a></td>
<td>&#160;</td>
<td>Name of an output table workspace containing peaks’ offset data.</td>
</tr>
<tr class="row-odd"><td>FittedResolutionWorkspace</td>
<td>Output</td>
<td><a class="reference internal" href="../concepts/MatrixWorkspace.html#matrixworkspace"><span class="std std-ref">MatrixWorkspace</span></a></td>
<td>ResolutionWS</td>
<td>Name of the resolution workspace containing delta(d)/d for each unmasked spectrum.</td>
</tr>
<tr class="row-even"><td>MinimumResolutionFactor</td>
<td>Input</td>
<td>number</td>
<td>0.1</td>
<td>Factor of the minimum allowed Delta(d)/d of any peak to its suggested Delta(d)/d.</td>
</tr>
<tr class="row-odd"><td>MaximumResolutionFactor</td>
<td>Input</td>
<td>number</td>
<td>10</td>
<td>Factor of the maximum allowed Delta(d)/d of any peak to its suggested Delta(d)/d.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="description">
<h2><a class="toc-backref" href="#id5">Description</a><a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h2>
<p>This algorithm requires a workspace that is in d-spacingand has been <a class="reference internal" href="Rebin-v1.html#algm-rebin"><span class="std std-ref">rebinned</span></a> to a common set of d-spacing bin boundaries. In this first step you select one spectrum to be the
reference spectrum and all of the other spectrum are cross correlated
against it. Each output spectrum then contains a peak whose location
defines the offset from the reference spectrum.</p>
<p>The algorithm iterates over each spectrum in the workspace and fits a
function (default is a <a class="reference internal" href="../fitting/fitfunctions/Gaussian.html#func-gaussian"><span class="std std-ref">Gaussian</span></a>) to the reference peak. The fit is used
to calculate the centre of the fitted peak, and the offset is then
calculated as:</p>
<p>This is then written into a <a class="reference internal" href="../concepts/calibration/CalFile.html#calfile"><span class="std std-ref">.cal file</span></a> for every detector
that contributes to that spectrum. All of the entries in the cal file
are initially set to both be included, but also to all group into a
single group on <a class="reference internal" href="DiffractionFocussing-v2.html#algm-diffractionfocussing"><span class="std std-ref">DiffractionFocussing v2</span></a>. The
<a class="reference internal" href="CreateCalFileByNames-v1.html#algm-createcalfilebynames"><span class="std std-ref">CreateCalFileByNames v1</span></a> algorithm can be used to
alter the grouping in the cal file.</p>
<div class="section" id="fit-for-peak-offset">
<h3><a class="toc-backref" href="#id6">Fit for peak offset</a><a class="headerlink" href="#fit-for-peak-offset" title="Permalink to this headline">¶</a></h3>
<p>The algorithm to calculate offset of peaks’ positions is to minimize a
cost function as</p>
<div class="math">
\[\sum_{p} |X_{0, p} - (1+offset)\cdot X_{0, p}|/\chi^2_{p}\]</div>
<p>, which p is the index of a peak whose position is within MinD and MaxD.</p>
</div>
<div class="section" id="criteria-on-peaks">
<h3><a class="toc-backref" href="#id7">Criteria on peaks</a><a class="headerlink" href="#criteria-on-peaks" title="Permalink to this headline">¶</a></h3>
<p>The (fitted) peak must meet a series of criteria to be used to fit
spectrum’s offset.</p>
<p>A peak will not be used if</p>
<ul class="simple">
<li>its centre is out of pre-defined d-range, i.e., MinD and MaxD;</li>
<li>its centre is out of fitting window if it is defined;</li>
<li>its <span class="math">\(\chi^2\)</span> of peak fitting is larger than pre-defined maximum
value;</li>
<li>its height is lower than pre-defined lowest peak height;</li>
<li>its observed maximum value corrected by background is smaller than user specified value;</li>
<li>its signal/noise ratio is less than 5
<span class="math">\(H\cdot FWHM\_To\_SIGMA/width &lt; 5\)</span>;</li>
<li>its height is not outside of error bars of background
<span class="math">\(H &lt; \sqrt{H + B}/2\)</span>;</li>
<li>its z-value on <span class="math">\(\frac{\delta d}{d}\)</span> is larger than 2.0;</li>
<li>its offset from theoretical position exceeds the limitation specified by user;</li>
<li>its resolution (<span class="math">\(\Delta(d)/d\)</span>) is out of user-specified range.</li>
</ul>
</div>
<div class="section" id="generate-fit-window">
<h3><a class="toc-backref" href="#id8">Generate fit window</a><a class="headerlink" href="#generate-fit-window" title="Permalink to this headline">¶</a></h3>
<p>There are two approach to generate fit window.  One is via property ‘FitWindowMaxWidth’;
and the other is ‘FitwindowTableWorkspace’.</p>
<p>If neither of these 2 properties are correctly specified, then then there won’t be any window defined.</p>
<div class="section" id="uniform-fit-window">
<h4><a class="toc-backref" href="#id9">Uniform fit window</a><a class="headerlink" href="#uniform-fit-window" title="Permalink to this headline">¶</a></h4>
<p>By specifying a positive float, maxWidth, for ‘FitWindowMaxWidth’,
it is the definition of fit window for peaks indexed from 0 to N-1:</p>
<blockquote>
<div><ul class="simple">
<li>Peak 0: window = <span class="math">\(\min((X0_0-dmin), maxWidth)\)</span>, <span class="math">\(\min((X0_1-X0_0)/2,maxWidth)\)</span></li>
<li>Peak <span class="math">\(i (0 &lt; i &lt; N-1)\)</span>: window = <span class="math">\(\min((X0_i-X0_{i-1})/2, maxWidth)\)</span>, <span class="math">\(\min((X0_1-X0_0)/2, maxWidth)\)</span></li>
<li>Peak <span class="math">\(N-1\)</span>: window = <span class="math">\(\min((X0_i-X0_{i-1})/2, maxWidth)\)</span>, <span class="math">\(\min((dmax-X0_i), maxWidth)\)</span></li>
</ul>
</div></blockquote>
<p>where <span class="math">\(X0_i\)</span> is the centre of i-th peak.</p>
</div>
<div class="section" id="fit-window-for-individual-peak">
<h4><a class="toc-backref" href="#id10">Fit window for individual peak</a><a class="headerlink" href="#fit-window-for-individual-peak" title="Permalink to this headline">¶</a></h4>
<p>FitwindowTableWorkspace contains the fit window for each individual peak in the workspace
to find.
It contains <span class="math">\(1+2\times N\)</span> columns, where N is the number of peaks positions specified in ‘DReference’.</p>
<ul class="simple">
<li>Column 0: spectrum number <span class="math">\(spNum\)</span>.  If <span class="math">\(spNum &lt; 0\)</span>, then it is a ‘universal’ spectrum;</li>
<li>Column <span class="math">\(2i+1\)</span>: left boundary of peak <span class="math">\(i\)</span> defined in ‘DReference’ of spectrum <span class="math">\(iws\)</span>;</li>
<li>Column <span class="math">\(2i+2\)</span>: right boundary of peak <span class="math">\(i\)</span> defined in ‘DReference’ of spectrum <span class="math">\(iws\)</span>;</li>
</ul>
<div class="section" id="default-fit-windows">
<h5><a class="toc-backref" href="#id11">Default fit windows</a><a class="headerlink" href="#default-fit-windows" title="Permalink to this headline">¶</a></h5>
<p>In the fit window table workspace, if there is a row, whose ‘spectrum number’ is a negative number,
then the fit windows defined in this row is treated as the default fit windows.
It means that for any spectrum that has no fit windows defined in the tableworkspace,
the default fit windows will be applied to it.</p>
</div>
</div>
</div>
</div>
<div class="section" id="quality-of-fitting">
<h2><a class="toc-backref" href="#id12">Quality of Fitting</a><a class="headerlink" href="#quality-of-fitting" title="Permalink to this headline">¶</a></h2>
<p>GetDetOffsetsMultiPeaks have 2 levels of fitting. First it will call
FindPeaks to fit Bragg peaks within d-range. Then it will fit offsets
from the peak positions obtained in the previous step. Therefore, the
performance of FindPeaks is critical to this algorithm. It is necessary
to output values reflecting the goodness of fitting of this algorithm to
users.</p>
<div class="section" id="number-of-spectra-that-are-not-masked">
<h3><a class="toc-backref" href="#id13">Number of spectra that are NOT masked</a><a class="headerlink" href="#number-of-spectra-that-are-not-masked" title="Permalink to this headline">¶</a></h3>
<p>A spectrum will be masked if it is a dead pixel, has an empty detector
or has no peak that can be fit with given peak positions. The
performance of <em>FindPeaks</em> affects the third criteria. A better
algorithm to find and fit peaks may save some spectrum with relatively
much fewer events received, i.e., poorer signal.</p>
</div>
<div class="section" id="of-the-offset-fitting-function">
<h3><a class="toc-backref" href="#id14"><span class="math">\(\chi^2\)</span> of the offset fitting function</a><a class="headerlink" href="#of-the-offset-fitting-function" title="Permalink to this headline">¶</a></h3>
<p>The goodness of fit, <span class="math">\(\chi^2_{spNum}\)</span>, of the offset fitting
function</p>
<div class="math">
\[\sum_{p} |X_{0, p} - (1+offset)X_{0, p}|\cdot H^2_{p}\]</div>
<p>is an important measure of fitting quality on each spectrum (indexed as
spNum).</p>
</div>
<div class="section" id="deviation-of-highest-peaks">
<h3><a class="toc-backref" href="#id15">Deviation of highest peaks</a><a class="headerlink" href="#deviation-of-highest-peaks" title="Permalink to this headline">¶</a></h3>
<p>We observed that in some situation, the calibrated peaks’ positions of
some spectra are far off to the targeted peak positions, while goodness
of fit such as <span class="math">\(\chi^2\)</span> are still good. It is usually caused by the
bad fit of one or two peaks in that spectrum, which feeds some erroreous
peak positions to peak offset fitting function.</p>
<p>This type of bad fitting is very easily identified by visualization,
because the shift of peaks from the correct positions is significant in
fill plot.</p>
<p>Therefore, deviation of highest peak if spectrum i, <span class="math">\(D_{i}\)</span> is
defined as:</p>
<div class="math">
\[D_{i} = |X^{(o)}\cdots(1+offset) - X^{(c)}|\]</div>
<p>where <span class="math">\(X^{(o)}\)</span> is the fitted centre of the highest peak of
spectrum i, and <span class="math">\(X^{(c)}\)</span> is the theoretical centre of this peak.</p>
</div>
<div class="section" id="collective-quantities-to-illustrate-goodness-of-fitting-still-in-development">
<h3><a class="toc-backref" href="#id16">Collective quantities to illustrate goodness of fitting (still in development)</a><a class="headerlink" href="#collective-quantities-to-illustrate-goodness-of-fitting-still-in-development" title="Permalink to this headline">¶</a></h3>
<p>Be noticed that the idea of this section is still under development and
has not been implemented yet.</p>
<p>On the other hand, since GetDetOffsetsMultiPeaks always operates on an
EventWorkspace with thousands or several ten thousands of spectra, it is
very hard to tell the quality of fitting by looking at
<span class="math">\(\chi^2_{spNum}\)</span> of all spectra. Hence, Here are two other
parameters are defined for comparison of results.</p>
<blockquote>
<div><span class="math">\(g_1 = \frac{\sum_{s}D_{s}^2}{N_{nm}}\)</span></div></blockquote>
<p>, where s is the index of any unmasked spectrum and <span class="math">\(N_{mn}\)</span> is
the number of unmasked spectra;</p>
<blockquote>
<div><span class="math">\(g_2 = \frac{\sum_{s}D_{s}^2\cdot H_{s}^2}{N_{nm}}\)</span>,</div></blockquote>
<p>where <span class="math">\(H_{s}\)</span> is the height of highest peak of spectrum s.</p>
</div>
<div class="section" id="standard-error-on-offset">
<h3><a class="toc-backref" href="#id17">Standard error on offset</a><a class="headerlink" href="#standard-error-on-offset" title="Permalink to this headline">¶</a></h3>
<p>The offset in unit of d-spacing differs is proportional to peak’s
position by definition:</p>
<div class="math">
\[X_0^{(f)} = X_0^{(o)} * (1+offset)\]</div>
<p>where <span class="math">\(X_0^{(f)}\)</span> is the focussed peak position, and
<span class="math">\(X_0^{(o)}\)</span> is the observed peak position by fitting.</p>
<p>As different spectrum covers different d-space range, the highest peak
differs. Therefore, the error of offset should be normalized by the
peak’s position.</p>
<div class="math">
\[E = (X_0^{(f)} - X_0^{(o)}*(1+offset))/X_0^{(f)} = 1 - \frac{X_0^{(o)}}{X_0^{(f)}}\cdot(1+offset)\]</div>
<p>And it is unitless.</p>
<p>By this mean, the error of all peaks should be close if they are fitted
correctly.</p>
</div>
</div>
<div class="section" id="spectra-to-be-masked">
<h2><a class="toc-backref" href="#id18">Spectra to be masked</a><a class="headerlink" href="#spectra-to-be-masked" title="Permalink to this headline">¶</a></h2>
<p>A MaskWorskpace is output from the algorithm.  Along with it, a TableWorkspace is output
to describe the status of offset calculation.</p>
<p>Here are the cases that a spectra (i.e., a detector) will be masked in the output MaskWorkspace.</p>
<ul class="simple">
<li>An empty spectrum (i.e., the corresponding EventList is empty).  It is noted as “empty det”;</li>
<li>A dead detector, i.e., the corresponding spectrum has counts less than <span class="math">\(10^{-3}\)</span> in defined d-range.  It isnoted as “dead det”;</li>
<li>A spectrum that does not have peak within specified d-range.  It is noted as “no peaks”. Here is the criteria for this case.</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>Algorithm FindPeaks fails to find any peak;</li>
<li>No peak found has height larger than specified ‘MinimumPeakHeight’;</li>
<li>No peak found has observed height larger than specified ‘MinimumPeakHeightObs’;</li>
<li>No peak found has resolution within specified range;</li>
<li>No peak found whose calculated offset is smaller than the user-defined maximum offset.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="usage">
<h2><a class="toc-backref" href="#id19">Usage</a><a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># Create a workspace with two Gaussian peaks in each spectrum</span>
<span class="n">function_str</span> <span class="o">=</span> <span class="s1">&#39;name=Gaussian,Height=3,PeakCentre=5,Sigma=0.3;name=Gaussian,Height=2.1,PeakCentre=15,Sigma=0.3&#39;</span>
<span class="n">ws</span> <span class="o">=</span> <span class="n">CreateSampleWorkspace</span><span class="p">(</span><span class="n">Function</span><span class="o">=</span><span class="s1">&#39;User Defined&#39;</span><span class="p">,</span><span class="n">UserDefinedFunction</span><span class="o">=</span><span class="n">function_str</span><span class="p">,</span><span class="n">XMin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">XMax</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">BinWidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="c1"># Make sure the X axis is in d-spacing.</span>
<span class="n">ws</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">setUnit</span><span class="p">(</span> <span class="s1">&#39;dSpacing&#39;</span> <span class="p">)</span>

<span class="c1"># Generate a file path to save the .cal file at.</span>
<span class="n">calFilePath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span> <span class="s1">&#39;~/MantidUsageExample_CalFile.cal&#39;</span> <span class="p">)</span>

<span class="c1"># Run the algorithm</span>
<span class="n">msk</span> <span class="o">=</span> <span class="n">GetDetOffsetsMultiPeaks</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span><span class="n">DReference</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">15</span><span class="p">],</span> <span class="n">GroupingFileName</span><span class="o">=</span><span class="n">calFilePath</span><span class="p">)</span>

<span class="c1"># Read the saved .cal file back in</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span> <span class="n">calFilePath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span> <span class="p">)</span>
<span class="n">file</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># Print out first 10 lines of the file</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">55</span><span class="p">]))</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">10</span><span class="p">]:</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="output">
<h3><a class="toc-backref" href="#id20">Output</a><a class="headerlink" href="#output" title="Permalink to this headline">¶</a></h3>
<div class="highlight-none"><div class="highlight"><pre><span></span># Calibration file for instrument basic_rect written on ...
# Format: number    UDET         offset    select    group
        0            100     -0.0033750       1       1
        1            101     -0.0033750       1       1
        2            102     -0.0033750       1       1
        3            103     -0.0033750       1       1
        4            104     -0.0033750       1       1
        5            105     -0.0033750       1       1
        6            106     -0.0033750       1       1
        7            107     -0.0033750       1       1
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">Algorithm <a class="reference internal" href="EstimateResolutionDiffraction-v1.html#algm-estimateresolutiondiffraction"><span class="std std-ref">EstimateResolutionDiffraction v1</span></a></p>
</div>
<p><strong>Categories</strong>: <a class="reference external" href="categories/AlgorithmIndex.html">AlgorithmIndex</a> | <a class="reference external" href="categories/Diffraction/Calibration.html">Diffraction\Calibration</a></p>
</div>
</div>
<div class="section" id="source">
<h2><a class="toc-backref" href="#id21">Source</a><a class="headerlink" href="#source" title="Permalink to this headline">¶</a></h2>
<p>C++ header: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/be3e0b0ee38557d9593e311f5a2f06503b508191/Framework/Algorithms/inc/MantidAlgorithms/GetDetOffsetsMultiPeaks.h">GetDetOffsetsMultiPeaks.h</a> <em>(last modified: 2020-03-25)</em></p>
<p>C++ source: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/be3e0b0ee38557d9593e311f5a2f06503b508191/Framework/Algorithms/src/GetDetOffsetsMultiPeaks.cpp">GetDetOffsetsMultiPeaks.cpp</a> <em>(last modified: 2020-04-07)</em></p>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
      <ul class="nav navbar-nav" style=" float: right;">
      
      
          
            
  <li>
    <a href="GetAllEi-v1.html" title="Previous Chapter: GetAllEi v1"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; GetAllEi v1</span>
    </a>
  </li>
  <li>
    <a href="GetDetectorOffsets-v1.html" title="Next Chapter: GetDetectorOffsets v1"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">GetDetectorOffsets v1 &raquo;</span>
    </a>
  </li>
          
       
          <li><a href="#">Back to top</a></li>
       </ul>
    <p>
      Last updated on 2021-02-09.<br/>
    </p>
  </div>
</footer>
  </body>
</html>