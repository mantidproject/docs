<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>SCDCalibratePanels v1</title>
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.3.6/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.3.6/css/bootstrap-theme.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '6.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="SNAPReduce v1" href="SNAPReduce-v1.html" />
    <link rel="prev" title="SANSWideAngleCorrection v1" href="SANSWideAngleCorrection-v1.html" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59110517-1', 'auto');
  ga('send', 'pageview');

</script>


  </head>
  <body>





  <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://www.mantidproject.org"><img src="../_static/Mantid_Logo_Transparent.png">
           </a>
        <span class="navbar-text navbar-version pull-left"><b>6.0</b></span>
      </div>

      
        <div class="collapse navbar-collapse nav-collapse">
      
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
                <li><a href="http://www.mantidproject.org">Home</a></li>
                <li><a href="http://download.mantidproject.org">Download</a></li>
                <li><a href="http://docs.mantidproject.org/nightly/">Documentation</a></li>
                <li><a href="http://www.mantidproject.org/Contact">Contact Us</a></li>
            
            
              
              
            
            
            
            
          </ul>
              
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
            </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <p><span class="math">\(\renewcommand\AA{\unicode{x212B}}\)</span></p>
<div class="section" id="scdcalibratepanels-v1">
<span id="algm-scdcalibratepanels"></span><span id="algm-scdcalibratepanels-v1"></span><h1>SCDCalibratePanels v1<a class="headerlink" href="#scdcalibratepanels-v1" title="Permalink to this headline">¶</a></h1>
<div class="figure align-right" id="id1">
<span id="index-0"></span><a class="screenshot reference internal image-reference" href="../_images/SCDCalibratePanels-v1_dlg.png"><img alt="../_images/SCDCalibratePanels-v1_dlg.png" class="screenshot" src="../_images/SCDCalibratePanels-v1_dlg.png" style="width: 349px;" /></a>
<p class="caption"><span class="caption-text"><strong>SCDCalibratePanels</strong> dialog.</span></p>
</div>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#summary" id="id2">Summary</a><ul>
<li><a class="reference internal" href="#see-also" id="id3">See Also</a></li>
</ul>
</li>
<li><a class="reference internal" href="#properties" id="id4">Properties</a></li>
<li><a class="reference internal" href="#description" id="id5">Description</a><ul>
<li><a class="reference internal" href="#output-workspaces-and-files" id="id6">OUTPUT workspaces and files:</a></li>
</ul>
</li>
<li><a class="reference internal" href="#after-calibration" id="id7">After Calibration</a></li>
<li><a class="reference internal" href="#usage" id="id8">Usage</a></li>
<li><a class="reference internal" href="#source" id="id9">Source</a></li>
</ul>
</div>
<div class="section" id="summary">
<h2><a class="toc-backref" href="#id2">Summary</a><a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>Panel parameters and L0 are optimized to minimize errors between theoretical and actual q values for the peaks</p>
<div class="section" id="see-also">
<h3><a class="toc-backref" href="#id3">See Also</a><a class="headerlink" href="#see-also" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="CalculateUMatrix-v1.html#algm-calculateumatrix"><span class="std std-ref">CalculateUMatrix</span></a></p>
</div>
</div>
<div class="section" id="properties">
<h2><a class="toc-backref" href="#id4">Properties</a><a class="headerlink" href="#properties" title="Permalink to this headline">¶</a></h2>
<table border="1" class="docutils">
<colgroup>
<col width="12%" />
<col width="4%" />
<col width="9%" />
<col width="12%" />
<col width="64%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Direction</th>
<th class="head">Type</th>
<th class="head">Default</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>PeakWorkspace</td>
<td>InOut</td>
<td>PeaksWorkspace</td>
<td><em>Mandatory</em></td>
<td>Workspace of Indexed Peaks</td>
</tr>
<tr class="row-odd"><td>a</td>
<td>Input</td>
<td>number</td>
<td><em>Optional</em></td>
<td>Lattice Parameter a (Leave empty to use lattice constants in peaks workspace)</td>
</tr>
<tr class="row-even"><td>b</td>
<td>Input</td>
<td>number</td>
<td><em>Optional</em></td>
<td>Lattice Parameter b (Leave empty to use lattice constants in peaks workspace)</td>
</tr>
<tr class="row-odd"><td>c</td>
<td>Input</td>
<td>number</td>
<td><em>Optional</em></td>
<td>Lattice Parameter c (Leave empty to use lattice constants in peaks workspace)</td>
</tr>
<tr class="row-even"><td>alpha</td>
<td>Input</td>
<td>number</td>
<td><em>Optional</em></td>
<td>Lattice Parameter alpha in degrees (Leave empty to use lattice constants in peaks workspace)</td>
</tr>
<tr class="row-odd"><td>beta</td>
<td>Input</td>
<td>number</td>
<td><em>Optional</em></td>
<td>Lattice Parameter beta in degrees (Leave empty to use lattice constants in peaks workspace)</td>
</tr>
<tr class="row-even"><td>gamma</td>
<td>Input</td>
<td>number</td>
<td><em>Optional</em></td>
<td>Lattice Parameter gamma in degrees (Leave empty to use lattice constants in peaks workspace)</td>
</tr>
<tr class="row-odd"><td>ChangeL1</td>
<td>Input</td>
<td>boolean</td>
<td>True</td>
<td>Change the L1(source to sample) distance</td>
</tr>
<tr class="row-even"><td>ChangeT0</td>
<td>Input</td>
<td>boolean</td>
<td>False</td>
<td>Change the T0 (initial TOF)</td>
</tr>
<tr class="row-odd"><td>ChangePanelSize</td>
<td>Input</td>
<td>boolean</td>
<td>True</td>
<td>Change the height and width of the detectors.  Implemented only for RectangularDetectors.</td>
</tr>
<tr class="row-even"><td>EdgePixels</td>
<td>Input</td>
<td>number</td>
<td>0</td>
<td>Remove peaks that are at pixels this close to edge.</td>
</tr>
<tr class="row-odd"><td>CalibrateBanks</td>
<td>Input</td>
<td>boolean</td>
<td>True</td>
<td>Calibrate the panels of the banks.</td>
</tr>
<tr class="row-even"><td>CalibrateSNAPPanels</td>
<td>Input</td>
<td>boolean</td>
<td>False</td>
<td>Calibrate the 3 X 3 panels of the sides of SNAP.</td>
</tr>
<tr class="row-odd"><td>DetCalFilename</td>
<td>Input</td>
<td>string</td>
<td>SCDCalibrate.DetCal</td>
<td>Path to an ISAW-style .detcal file to save. Allowed extensions: [‘.detcal’, ‘.det_cal’]</td>
</tr>
<tr class="row-even"><td>XmlFilename</td>
<td>Input</td>
<td>string</td>
<td>&#160;</td>
<td>Path to an Mantid .xml description(for LoadParameterFile) file to save. Allowed extensions: [‘.xml’]</td>
</tr>
<tr class="row-odd"><td>ColFilename</td>
<td>Input</td>
<td>string</td>
<td>ColCalcvsTheor.nxs</td>
<td>Path to a NeXus file comparing calculated and theoretical column of each peak. Allowed extensions: [‘.nxs’]</td>
</tr>
<tr class="row-even"><td>RowFilename</td>
<td>Input</td>
<td>string</td>
<td>RowCalcvsTheor.nxs</td>
<td>Path to a NeXus file comparing calculated and theoretical row of each peak. Allowed extensions: [‘.nxs’]</td>
</tr>
<tr class="row-odd"><td>TofFilename</td>
<td>Input</td>
<td>string</td>
<td>TofCalcvsTheor.nxs</td>
<td>Path to a NeXus file comparing calculated and theoretical TOF of each peak. Allowed extensions: [‘.nxs’]</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="description">
<h2><a class="toc-backref" href="#id5">Description</a><a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h2>
<p>This algorithm calibrates panels of Rectangular Detectors
or packs of tubes in an instrument.  The initial path,
panel centers and orientations are adjusted so the error in Q
positions from the theoretical Q positions is minimized.
Given a set of peaks indexed by <span class="math">\((h_i, k_i, l_i)\)</span>, we
modify the instrument parameters, p, and then find  Q in the sample frame,
<span class="math">\(\rm Q_{sample}\)</span> that mininizes the following:</p>
<div class="math">
\[\begin{split}\left\vert 2\pi \rm U \rm B \left(
                            \begin{array}{c}
                              NINT(h_i) \\
                              NINT(k_i) \\
                              NINT(l_i) \\
                            \end{array}
                          \right) - \rm Q_{sample,i}(p) \right\vert ^2\end{split}\]</div>
<p>NINT is the nearest integer function.
B is fixed from the input lattice parameters, but U is modified by <a class="reference internal" href="CalculateUMatrix-v1.html#algm-calculateumatrix"><span class="std std-ref">CalculateUMatrix</span></a>
for all peaks before and after optimization.
When the peaks are indexed, sample offsets are adjusted to better index the peaks.
The initial time-of-flight, T0, is optimized for all peaks before any parameters are optimized.
The initial path, L1, is optimized for all peaks before and after all panels or packs’ parameters are optimized.
The panels and packs’ parameters are optimized in parallel.
An option is available to adjust the panel widths and heights for Rectangular Detectors in a second iteration with all the other parameters fixed.</p>
<div class="section" id="output-workspaces-and-files">
<h3><a class="toc-backref" href="#id6">OUTPUT workspaces and files:</a><a class="headerlink" href="#output-workspaces-and-files" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>The results are saved to an ISAW-like DetCal file and optionally in an xml
file that can be used with the <a class="reference internal" href="LoadParameterFile-v1.html#algm-loadparameterfile"><span class="std std-ref">LoadParameterFile</span></a> algorithm.</li>
<li>There are two output workspace groups that are output when this algorithm calls the <a class="reference internal" href="Fit-v1.html#algm-fit"><span class="std std-ref">Fit</span></a> algorithm.<ol class="loweralpha">
<li>Fit_Parameters: workspaces beginning with ‘params’ contains the results from fitting for each bank and for L1.<ul>
<li>XShift, YShift,and&nbsp;ZShift&nbsp;are&nbsp;in&nbsp;meters.</li>
<li>XRotate, YRotate,&nbsp;and&nbsp;ZRotate&nbsp;are&nbsp;in&nbsp;degrees.</li>
</ul>
</li>
<li>Fit_Residuals: workspaces beginning with ‘fit’ contain the differences in the calculated and theoretical Q vectors for each peak.</li>
</ol>
</li>
<li>There are three output files that show the goodness of the calibration.<ol class="loweralpha">
<li>ColFilename&nbsp;contains&nbsp;the&nbsp;calculated and theoretical column for&nbsp;each&nbsp;peak. Each spectra is labeled by the bank. To plot use python script, scripts/SCD_Reduction/SCDCalibratePanelsResults.py</li>
<li>RowFilename&nbsp;contains&nbsp;the&nbsp;calculated and theoretical row for&nbsp;each&nbsp;peak. Each spectra is labeled by the bank. To plot use python script, scripts/SCD_Reduction/SCDCalibratePanelsResults.py</li>
<li>TofFilename&nbsp;contains&nbsp;the&nbsp;calculated and theoretical TOF for&nbsp;each&nbsp;peak.  Each spectra is labeled by the bank.</li>
</ol>
</li>
</ol>
</div>
</div>
<div class="section" id="after-calibration">
<h2><a class="toc-backref" href="#id7">After Calibration</a><a class="headerlink" href="#after-calibration" title="Permalink to this headline">¶</a></h2>
<p>After calibration, you can save the workspace to Nexus (or Nexus
processed) and get it back by loading in a later Mantid session. You can
copy the calibration to another workspace using the same instrument by
means of the <a class="reference internal" href="CopyInstrumentParameters-v1.html#algm-copyinstrumentparameters"><span class="std std-ref">CopyInstrumentParameters v1</span></a>
algorithm. To do so select the workspace, which you have calibrated as
the InputWorkspace and the workspace you want to copy the calibration
to, the OutputWorkspace.</p>
</div>
<div class="section" id="usage">
<h2><a class="toc-backref" href="#id8">Usage</a><a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1">#Calibrate peaks file and load to workspace</span>
<span class="n">LoadIsawPeaks</span><span class="p">(</span><span class="n">Filename</span><span class="o">=</span><span class="s1">&#39;MANDI_801.peaks&#39;</span><span class="p">,</span> <span class="n">OutputWorkspace</span><span class="o">=</span><span class="s1">&#39;peaks&#39;</span><span class="p">)</span>
<span class="c1">#TimeOffset is not stored in xml file, so use DetCal output if you need TimeOffset</span>
<span class="n">SCDCalibratePanels</span><span class="p">(</span><span class="n">PeakWorkspace</span><span class="o">=</span><span class="s1">&#39;peaks&#39;</span><span class="p">,</span><span class="n">DetCalFilename</span><span class="o">=</span><span class="s1">&#39;mandi_801.DetCal&#39;</span><span class="p">,</span><span class="n">XmlFilename</span><span class="o">=</span><span class="s1">&#39;mandi_801.xml&#39;</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="mi">74</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="mf">74.5</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="mf">99.9</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span><span class="n">gamma</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="n">LoadEmptyInstrument</span><span class="p">(</span><span class="n">Filename</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">getInstrumentDirectory</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;MANDI_Definition_2013_08_01.xml&#39;</span><span class="p">,</span> <span class="n">OutputWorkspace</span><span class="o">=</span><span class="s1">&#39;MANDI_801_event_DetCal&#39;</span><span class="p">)</span>
<span class="n">CloneWorkspace</span><span class="p">(</span><span class="n">InputWorkspace</span><span class="o">=</span><span class="s1">&#39;MANDI_801_event_DetCal&#39;</span><span class="p">,</span> <span class="n">OutputWorkspace</span><span class="o">=</span><span class="s1">&#39;MANDI_801_event_xml&#39;</span><span class="p">)</span>
<span class="n">LoadParameterFile</span><span class="p">(</span><span class="n">Workspace</span><span class="o">=</span><span class="s1">&#39;MANDI_801_event_xml&#39;</span><span class="p">,</span> <span class="n">Filename</span><span class="o">=</span><span class="s1">&#39;mandi_801.xml&#39;</span><span class="p">)</span>
<span class="n">LoadIsawDetCal</span><span class="p">(</span><span class="n">InputWorkspace</span><span class="o">=</span><span class="s1">&#39;MANDI_801_event_DetCal&#39;</span><span class="p">,</span> <span class="n">Filename</span><span class="o">=</span><span class="s1">&#39;mandi_801.DetCal&#39;</span><span class="p">)</span>
<span class="n">det1</span> <span class="o">=</span> <span class="n">mtd</span><span class="p">[</span><span class="s1">&#39;MANDI_801_event_DetCal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getInstrument</span><span class="p">()</span><span class="o">.</span><span class="n">getDetector</span><span class="p">(</span><span class="mi">327680</span><span class="p">)</span>
<span class="n">det2</span> <span class="o">=</span> <span class="n">mtd</span><span class="p">[</span><span class="s1">&#39;MANDI_801_event_xml&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getInstrument</span><span class="p">()</span><span class="o">.</span><span class="n">getDetector</span><span class="p">(</span><span class="mi">327680</span><span class="p">)</span>
<span class="k">if</span> <span class="n">det1</span><span class="o">.</span><span class="n">getPos</span><span class="p">()</span> <span class="o">==</span> <span class="n">det2</span><span class="o">.</span><span class="n">getPos</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;matches&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>matches
</pre></div>
</div>
<p><strong>Categories</strong>: <a class="reference external" href="categories/AlgorithmIndex.html">AlgorithmIndex</a> | <a class="reference external" href="categories/Crystal/Corrections.html">Crystal\Corrections</a></p>
</div>
<div class="section" id="source">
<h2><a class="toc-backref" href="#id9">Source</a><a class="headerlink" href="#source" title="Permalink to this headline">¶</a></h2>
<p>C++ header: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/be3e0b0ee38557d9593e311f5a2f06503b508191/Framework/Crystal/inc/MantidCrystal/SCDCalibratePanels.h">SCDCalibratePanels.h</a> <em>(last modified: 2020-04-07)</em></p>
<p>C++ source: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/be3e0b0ee38557d9593e311f5a2f06503b508191/Framework/Crystal/src/SCDCalibratePanels.cpp">SCDCalibratePanels.cpp</a> <em>(last modified: 2020-04-07)</em></p>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
      <ul class="nav navbar-nav" style=" float: right;">
      
      
          
            
  <li>
    <a href="SANSWideAngleCorrection-v1.html" title="Previous Chapter: SANSWideAngleCorrection v1"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; SANSWideAngle...</span>
    </a>
  </li>
  <li>
    <a href="SNAPReduce-v1.html" title="Next Chapter: SNAPReduce v1"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">SNAPReduce v1 &raquo;</span>
    </a>
  </li>
          
       
          <li><a href="#">Back to top</a></li>
       </ul>
    <p>
      Last updated on 2021-02-09.<br/>
    </p>
  </div>
</footer>
  </body>
</html>