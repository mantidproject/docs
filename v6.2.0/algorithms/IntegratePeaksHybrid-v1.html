<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>IntegratePeaksHybrid v1</title>
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.3.6/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.3.6/css/bootstrap-theme.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '6.2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="IntegratePeaksMD v1" href="IntegratePeaksMD-v1.html" />
    <link rel="prev" title="IntegratePeaksCWSD v1" href="IntegratePeaksCWSD-v1.html" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59110517-1', 'auto');
  ga('send', 'pageview');

</script>


  </head>
  <body>





  <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://www.mantidproject.org"><img src="../_static/Mantid_Logo_Transparent.png">
           </a>
        <span class="navbar-text navbar-version pull-left"><b>6.2</b></span>
      </div>

      
        <div class="collapse navbar-collapse nav-collapse">
      
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
                <li><a href="http://www.mantidproject.org">Home</a></li>
                <li><a href="http://download.mantidproject.org">Download</a></li>
                <li><a href="http://docs.mantidproject.org/nightly/">Documentation</a></li>
                <li><a href="http://www.mantidproject.org/Contact">Contact Us</a></li>
            
            
              
              
            
            
            
            
          </ul>
              
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
            </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <p><span class="math">\(\renewcommand\AA{\unicode{x212B}}\)</span></p>
<div class="section" id="integratepeakshybrid-v1">
<span id="algm-integratepeakshybrid"></span><span id="algm-integratepeakshybrid-v1"></span><h1>IntegratePeaksHybrid v1<a class="headerlink" href="#integratepeakshybrid-v1" title="Permalink to this headline">¶</a></h1>
<div class="figure align-right" id="id1">
<span id="index-0"></span><a class="screenshot reference internal image-reference" href="../_images/IntegratePeaksHybrid-v1_dlg.png"><img alt="../_images/IntegratePeaksHybrid-v1_dlg.png" class="screenshot" src="../_images/IntegratePeaksHybrid-v1_dlg.png" style="width: 349px;" /></a>
<p class="caption"><span class="caption-text"><strong>IntegratePeaksHybrid</strong> dialog.</span></p>
</div>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#summary" id="id3">Summary</a><ul>
<li><a class="reference internal" href="#see-also" id="id4">See Also</a></li>
</ul>
</li>
<li><a class="reference internal" href="#properties" id="id5">Properties</a></li>
<li><a class="reference internal" href="#description" id="id6">Description</a></li>
<li><a class="reference internal" href="#warnings-and-logging" id="id7">Warnings and Logging</a><ul>
<li><a class="reference internal" href="#off-the-image-edge" id="id8">Off the Image Edge</a></li>
<li><a class="reference internal" href="#no-cluster-corresponding-to-peak" id="id9">No Cluster Corresponding to Peak</a></li>
</ul>
</li>
<li><a class="reference internal" href="#usage" id="id10">Usage</a></li>
<li><a class="reference internal" href="#source" id="id11">Source</a></li>
</ul>
</div>
<div class="section" id="summary">
<h2><a class="toc-backref" href="#id3">Summary</a><a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>Integrate single crystal peaks using connected component analysis. Binning invididual to each peak.</p>
<div class="section" id="see-also">
<h3><a class="toc-backref" href="#id4">See Also</a><a class="headerlink" href="#see-also" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="IntegratePeaksUsingClusters-v1.html#algm-integratepeaksusingclusters"><span class="std std-ref">IntegratePeaksUsingClusters</span></a>, <a class="reference internal" href="IntegratePeaksMDHKL-v1.html#algm-integratepeaksmdhkl"><span class="std std-ref">IntegratePeaksMDHKL</span></a>, <a class="reference internal" href="IntegratePeaksMD-v2.html#algm-integratepeaksmd"><span class="std std-ref">IntegratePeaksMD</span></a>, <a class="reference internal" href="IntegratePeaksCWSD-v1.html#algm-integratepeakscwsd"><span class="std std-ref">IntegratePeaksCWSD</span></a></p>
</div>
</div>
<div class="section" id="properties">
<h2><a class="toc-backref" href="#id5">Properties</a><a class="headerlink" href="#properties" title="Permalink to this headline">¶</a></h2>
<table border="1" class="docutils">
<colgroup>
<col width="12%" />
<col width="4%" />
<col width="21%" />
<col width="7%" />
<col width="56%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Direction</th>
<th class="head">Type</th>
<th class="head">Default</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>InputWorkspace</td>
<td>Input</td>
<td><a class="reference internal" href="../concepts/MDWorkspace.html#mdworkspace"><span class="std std-ref">MDEventWorkspace</span></a></td>
<td><em>Mandatory</em></td>
<td>Input md workspace.</td>
</tr>
<tr class="row-odd"><td>PeaksWorkspace</td>
<td>Input</td>
<td>PeaksWorkspace</td>
<td><em>Mandatory</em></td>
<td>A PeaksWorkspace containing the peaks to integrate.</td>
</tr>
<tr class="row-even"><td>NumberOfBins</td>
<td>Input</td>
<td>number</td>
<td>20</td>
<td>Number of bins to use while creating each local image. Defaults to 20. Increase to reduce pixelation</td>
</tr>
<tr class="row-odd"><td>BackgroundOuterRadius</td>
<td>Input</td>
<td>number</td>
<td><em>Mandatory</em></td>
<td>Background outer radius estimate. Choose liberal value.</td>
</tr>
<tr class="row-even"><td>OutputWorkspace</td>
<td>Output</td>
<td>PeaksWorkspace</td>
<td><em>Mandatory</em></td>
<td>An output integrated peaks workspace.</td>
</tr>
<tr class="row-odd"><td>OutputWorkspaces</td>
<td>Output</td>
<td>WorkspaceGroup</td>
<td><em>Mandatory</em></td>
<td>MDHistoWorkspaces containing the labeled clusters used by the algorithm.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="description">
<h2><a class="toc-backref" href="#id6">Description</a><a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h2>
<p>This is a hybrid between <a class="reference internal" href="IntegratePeaksMD-v2.html#algm-integratepeaksmd"><span class="std std-ref">IntegratePeaksMD v2</span></a> and <a class="reference internal" href="IntegratePeaksUsingClusters-v1.html#algm-integratepeaksusingclusters"><span class="std std-ref">IntegratePeaksUsingClusters v1</span></a>. Each peak region is treated as a separate image and rebinned accordingly. The background threshold is automatically determined around each peak, by averaging over all pixels in that region.
The NumberOfBins and BackgroundOuterRadius are global to all Peaks. The actual background threshold is calculated independently for each peak based on NumberOfBins, BackgroundOuterRadius and the signal values in that region. This algorithm is in general faster than <a class="reference internal" href="IntegratePeaksUsingClusters-v1.html#algm-integratepeaksusingclusters"><span class="std std-ref">IntegratePeaksUsingClusters v1</span></a> and has a better ability to distinguish peaks from the background because each peak is treated independently.</p>
<p>Integrates arbitrary shaped single crystal peaks defined on an
<a class="reference internal" href="../concepts/MDHistoWorkspace.html#mdhistoworkspace"><span class="std std-ref">MDHistoWorkspace</span></a> using connected component
analysis to determine regions of interest around each peak of the
<a class="reference internal" href="../concepts/PeaksWorkspace.html#peaksworkspace"><span class="std std-ref">PeaksWorkspace</span></a>. The output is an integrated
<a class="reference internal" href="../concepts/PeaksWorkspace.html#peaksworkspace"><span class="std std-ref">PeaksWorkspace</span></a> as well as a group of images <a class="reference internal" href="../concepts/WorkspaceGroup.html#workspacegroup"><span class="std std-ref">WorkspaceGroup</span></a> of <a class="reference internal" href="../concepts/MDWorkspace.html#mdworkspace"><span class="std std-ref">MDWorkspaces</span></a>  containing the
labels assigned to each cluster for diagnostic and visualisation
purposes.</p>
<p><strong>The algorithm makes no assmptions about Peak shape or size</strong> and can
therefore be used where integration over defined shapes
<a class="reference internal" href="IntegratePeaksMD-v2.html#algm-integratepeaksmd"><span class="std std-ref">IntegratePeaksMD v2</span></a> and
<a class="reference internal" href="IntegrateEllipsoids-v1.html#algm-integrateellipsoids"><span class="std std-ref">IntegrateEllipsoids v1</span></a>, for example, will not
work.</p>
<div class="figure" id="id2">
<img alt="ClusterImage.png" src="../_images/ClusterImage.png" />
<p class="caption"><span class="caption-text">Cluster Label region displayed in the <a class="reference internal" href="../workbench/sliceviewer.html#sliceviewer"><span class="std std-ref">Sliceviewer</span></a>.
Peak centre is marked with an X.
The green circle illustrates the integration region used by <a class="reference internal" href="IntegratePeaksMD-v2.html#algm-integratepeaksmd"><span class="std std-ref">IntegratePeaksMD v2</span></a></span></p>
</div>
</div>
<div class="section" id="warnings-and-logging">
<h2><a class="toc-backref" href="#id7">Warnings and Logging</a><a class="headerlink" href="#warnings-and-logging" title="Permalink to this headline">¶</a></h2>
<p>The algorithm will generate warning. There are three main warning to
know about.</p>
<div class="section" id="off-the-image-edge">
<h3><a class="toc-backref" href="#id8">Off the Image Edge</a><a class="headerlink" href="#off-the-image-edge" title="Permalink to this headline">¶</a></h3>
<p>The algorithm will warn about unreachable peaks (off the image). This
may be because the peaks detected were off the edge of the detector, or
because the image was cropped in BinMD in such a way that that part of
the detector/TOF space is no longer accessible.</p>
</div>
<div class="section" id="no-cluster-corresponding-to-peak">
<h3><a class="toc-backref" href="#id9">No Cluster Corresponding to Peak</a><a class="headerlink" href="#no-cluster-corresponding-to-peak" title="Permalink to this headline">¶</a></h3>
<p>This is because the input <a class="reference internal" href="../concepts/PeaksWorkspace.html#peaksworkspace"><span class="std std-ref">PeaksWorkspace</span></a> has peaks
that do not align with peaks in the image. The error could either be on
the side of the input PeaksWorkspace (spurious peaks), or of the
<a class="reference internal" href="../concepts/MDHistoWorkspace.html#mdhistoworkspace"><span class="std std-ref">MDHistoWorkspace</span></a> generated as part of processing.
One thing to verify is that the combination of Threshold and
Normalization input parameters are not so low that they are treating
genuine peaks in the image as background.</p>
</div>
</div>
<div class="section" id="usage">
<h2><a class="toc-backref" href="#id10">Usage</a><a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p><strong>Example - Simple Integration of TOPAZ data</strong></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="k">def</span> <span class="nf">make_input_workspaces</span><span class="p">():</span>
    <span class="n">instrument_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">getInstrumentDirectory</span><span class="p">(),</span> <span class="s1">&#39;SXD_Definition.xml&#39;</span><span class="p">)</span>
    <span class="n">sxd</span> <span class="o">=</span> <span class="n">LoadEmptyInstrument</span><span class="p">(</span><span class="n">Filename</span><span class="o">=</span><span class="n">instrument_path</span><span class="p">)</span>
    <span class="c1"># Set lattice parameters</span>
    <span class="n">SetUB</span><span class="p">(</span><span class="n">sxd</span><span class="p">,</span> <span class="mf">5.6</span><span class="p">,</span> <span class="mf">5.6</span><span class="p">,</span> <span class="mf">5.6</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>
    <span class="c1"># Predict peaks</span>
    <span class="n">predicted</span> <span class="o">=</span> <span class="n">PredictPeaks</span><span class="p">(</span><span class="n">sxd</span><span class="p">)</span>
    <span class="c1"># Keep every 20th predicted peak for speed</span>
    <span class="n">rows_to_delete</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">predicted</span><span class="o">.</span><span class="n">getNumberPeaks</span><span class="p">()))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">predicted</span><span class="o">.</span><span class="n">getNumberPeaks</span><span class="p">())</span> <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">20</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">DeleteTableRows</span><span class="p">(</span><span class="n">predicted</span><span class="p">,</span> <span class="n">Rows</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rows_to_delete</span><span class="p">))</span>

    <span class="c1"># Set the Frame to QLab</span>
    <span class="n">mdws</span> <span class="o">=</span> <span class="n">CreateMDWorkspace</span><span class="p">(</span><span class="n">Dimensions</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">Extents</span><span class="o">=</span><span class="s1">&#39;-10,10,-10,10,-10,10&#39;</span><span class="p">,</span>
                                           <span class="n">Names</span><span class="o">=</span><span class="s1">&#39;Q_lab_x,Q_lab_y,Q_lab_z&#39;</span><span class="p">,</span> <span class="n">Frames</span> <span class="o">=</span> <span class="s2">&quot;QLab,QLab,QLab&quot;</span><span class="p">,</span>
                                           <span class="n">Units</span><span class="o">=</span><span class="s1">&#39;U,U,U&#39;</span><span class="p">)</span>
    <span class="n">qlab</span> <span class="o">=</span> <span class="n">predicted</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="s1">&#39;QLab&#39;</span><span class="p">)</span>
    <span class="n">peak_radius</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">n_events</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="k">for</span> <span class="n">coords</span> <span class="ow">in</span> <span class="n">qlab</span><span class="p">:</span>
        <span class="n">FakeMDEventData</span><span class="p">(</span><span class="n">InputWorkspace</span><span class="o">=</span><span class="n">mdws</span><span class="p">,</span> <span class="n">PeakParams</span><span class="o">=</span><span class="p">[</span><span class="n">n_events</span><span class="p">,</span> <span class="n">coords</span><span class="o">.</span><span class="n">X</span><span class="p">(),</span> <span class="n">coords</span><span class="o">.</span><span class="n">Y</span><span class="p">(),</span> <span class="n">coords</span><span class="o">.</span><span class="n">Z</span><span class="p">(),</span> <span class="n">peak_radius</span><span class="p">])</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">predicted</span><span class="p">,</span> <span class="n">mdws</span><span class="p">,</span> <span class="n">peak_radius</span><span class="p">)</span>

<span class="n">predicted</span><span class="p">,</span> <span class="n">mdws</span><span class="p">,</span> <span class="n">peak_radius</span> <span class="o">=</span> <span class="n">make_input_workspaces</span><span class="p">()</span>
<span class="c1"># Perform the integration</span>
<span class="n">integrated</span><span class="p">,</span> <span class="n">clusters</span> <span class="o">=</span> <span class="n">IntegratePeaksHybrid</span><span class="p">(</span><span class="n">InputWorkspace</span><span class="o">=</span><span class="n">mdws</span><span class="p">,</span> <span class="n">PeaksWorkspace</span><span class="o">=</span><span class="n">predicted</span><span class="p">,</span> <span class="n">NumberOfBins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">BackgroundOuterRadius</span><span class="o">=</span><span class="n">peak_radius</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Categories</strong>: <a class="reference external" href="categories/AlgorithmIndex.html">AlgorithmIndex</a> | <a class="reference external" href="categories/MDAlgorithms/Peaks.html">MDAlgorithms\Peaks</a> | <a class="reference external" href="categories/Crystal/Integration.html">Crystal\Integration</a></p>
</div>
<div class="section" id="source">
<h2><a class="toc-backref" href="#id11">Source</a><a class="headerlink" href="#source" title="Permalink to this headline">¶</a></h2>
<p>C++ header: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/bf806d7983f959aff3ce91819ad740a97f95ef50/Framework/Crystal/inc/MantidCrystal/IntegratePeaksHybrid.h">IntegratePeaksHybrid.h</a> <em>(last modified: 2021-03-31)</em></p>
<p>C++ source: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/bf806d7983f959aff3ce91819ad740a97f95ef50/Framework/Crystal/src/IntegratePeaksHybrid.cpp">IntegratePeaksHybrid.cpp</a> <em>(last modified: 2021-03-31)</em></p>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
      <ul class="nav navbar-nav" style=" float: right;">
      
      
          
            
  <li>
    <a href="IntegratePeaksCWSD-v1.html" title="Previous Chapter: IntegratePeaksCWSD v1"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; IntegratePeaksCWSD v1</span>
    </a>
  </li>
  <li>
    <a href="IntegratePeaksMD-v1.html" title="Next Chapter: IntegratePeaksMD v1"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">IntegratePeaksMD v1 &raquo;</span>
    </a>
  </li>
          
       
          <li><a href="#">Back to top</a></li>
       </ul>
    <p>
      Last updated on 2021-09-29.<br/>
    </p>
  </div>
</footer>
  </body>
</html>