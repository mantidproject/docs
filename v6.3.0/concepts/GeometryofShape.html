<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Geometry of Shape</title>
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.3.6/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.3.6/css/bootstrap-theme.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '6.3.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Transition to the HistogramData module" href="HistogramData.html" />
    <link rel="prev" title="Geometry of Position" href="GeometryofPosition.html" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59110517-1', 'auto');
  ga('send', 'pageview');

</script>


  </head>
  <body>





  <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://www.mantidproject.org"><img src="../_static/Mantid_Logo_Transparent.png">
           </a>
        <span class="navbar-text navbar-version pull-left"><b>6.3</b></span>
      </div>

      
        <div class="collapse navbar-collapse nav-collapse">
      
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
                <li><a href="http://www.mantidproject.org">Home</a></li>
                <li><a href="http://download.mantidproject.org">Download</a></li>
                <li><a href="http://docs.mantidproject.org/nightly/">Documentation</a></li>
                <li><a href="http://www.mantidproject.org/Contact">Contact Us</a></li>
            
            
              
              
            
            
            
            
          </ul>
              
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
            </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <p><span class="math">\(\renewcommand\AA{\unicode{x212B}}\)</span></p>
<div class="section" id="geometry-of-shape">
<span id="id1"></span><h1>Geometry of Shape<a class="headerlink" href="#geometry-of-shape" title="Permalink to this headline">¶</a></h1>
<div class="section" id="what-is-it">
<h2>What is it?<a class="headerlink" href="#what-is-it" title="Permalink to this headline">¶</a></h2>
<p>In Mantid we use <a class="reference external" href="http://en.wikipedia.org/wiki/Constructive_solid_geometry">constructive solid geometry
(CSG)</a> to
describe the shape of an object. This involves the creation of more
complex shapes by the union, complement or intersection of simple
primitive surfaces.</p>
</div>
<div class="section" id="why-did-we-use-csg">
<h2>Why did we use CSG<a class="headerlink" href="#why-did-we-use-csg" title="Permalink to this headline">¶</a></h2>
<p>Defining our object shape using CSG was selected for a number of
reasons:</p>
<ol class="arabic simple">
<li>Using Surfaces based on mathematical equations rather than meshes of
vertices give much better accuracy when tracking the interaction of
particles through objects.</li>
<li>Scientists think in the shape of objects this way, for example if
they have a sample that is a sphere radius 0.03m with a conical
extrusion on top then that is exactly how they describe it in CSG.
Otherwise they would need to be able to describe the co-ordinates for
each vertex of the surface.</li>
</ol>
</div>
<div class="section" id="what-shapes-can-be-constructed">
<h2>What shapes can be constructed<a class="headerlink" href="#what-shapes-can-be-constructed" title="Permalink to this headline">¶</a></h2>
<p>Mantid has direct support for creating various shapes directly,
including</p>
<ul class="simple">
<li>Sphere</li>
<li>Infinite Cylinder</li>
<li>Cylinder (finite height)</li>
<li>Slice of cylinder ring</li>
<li>Infinite Plane</li>
<li>Cuboid</li>
<li>Infinite Cone</li>
</ul>
<p>Some of these shapes are infinite surfaces (the infinite plane, cone and
cylinder) these are therefore not very useful on there own, but in
combination with other shapes they can be capped as required.</p>
<p>For example if you cap and infinite Cylinder with two infinite planes
you get a finite capped cylinder. This is in fact how the Cylinder shape
is defined internally within Mantid.</p>
<p>For more on this see
<a class="reference internal" href="HowToDefineGeometricShape.html#howtodefinegeometricshape"><span class="std std-ref">HowToDefineGeometricShape</span></a>.</p>
</div>
<div class="section" id="calculating-intersections-between-shapes">
<h2>Calculating intersections between shapes<a class="headerlink" href="#calculating-intersections-between-shapes" title="Permalink to this headline">¶</a></h2>
<div class="section" id="intersection-of-a-line-and-a-cylinder">
<h3>Intersection of a line and a cylinder<a class="headerlink" href="#intersection-of-a-line-and-a-cylinder" title="Permalink to this headline">¶</a></h3>
<p>The line in Mantid is the equivalent of a ray in Math, and the cylinder here is
referring to a cylindrical surface.
The current intersection solver implemented in Mantid is using the parametrization
method where a quadratic equation is solved to find the intersection point.
This section will provide an in-depth derivation on how the final parameterization
is formed, which is directly used in the source code.</p>
<p>For an arbitrary cylindrical surface, it can be uniquely defined by its radius <span class="math">\(r\)</span>
and symmetry axis <span class="math">\(\mathbf\epsilon\)</span>.
Similarly, a line/ray can be uniquely defined by its starting point <span class="math">\(\mathbf{p}\)</span>
and direction vector (unit vector) <span class="math">\(\mathbf{\mu}\)</span>.
Through parameterization, we can express an arbitrary line/ray in 3D as:</p>
<div class="math">
\[\begin{split}\begin{cases}
   x = p_0 + \mu_0 \cdot \lambda \\
   y = p_1 + \mu_1 \cdot \lambda \\
   z = p_2 + \mu_2 \cdot \lambda
\end{cases}\end{split}\]</div>
<p>where <span class="math">\(\lambda\)</span> is the distance one need to walk from the starting point along
the direction of <span class="math">\(\mathbf{\mu}\)</span> to reach a point on the line.</p>
<p>The parameterization of a random cylindrical surface in 3D can be complicated, but
there is a simple mathematical expression when some special reference frame is used.
More specifically, when the symmetry axis is one of the axis of the reference
frame (using z-axis as an example here), a cylindrical surface can be expressed as:</p>
<div class="math">
\[x^2 + y^2 = r^2\]</div>
<p>The easiest way to solve for the intersection point is to plug the line parameterization
into the equation above.
However, this is not possible at the moment because the two equations are not in
the same reference frame.
Therefore, we need to convert the line parameterization parameters into the special
cylindrical surface reference framework before we can solve for <span class="math">\(\lambda\)</span>.</p>
<div class="figure">
<img alt="lineCylinderInterceptSchematics.pdf" src="../_images/lineCylinderInterceptSchematics.png" />
</div>
<p>The figure above shows one of the special reference frame that can make the math
a lot easier to handle.
In this reference frame, the origin is a random point along the symmetry axis of
the cylinder surface, and the symmetry axis is the z-axis.
The starting point of the line, <span class="math">\(\mathbf{p}\)</span> and the z-axis defines the
x-z plane.
In this reference frame, the expression for the cylindrical surface is exactly
the same as the one shown above, and the line parameterization can be expressed
as</p>
<div class="math">
\[\begin{split}\begin{cases}
x = p_x + \mu_x \cdot \lambda \\
y = p_y + \mu_y \cdot \lambda \\
z = p_z + \mu_z \cdot \lambda
\end{cases}\end{split}\]</div>
<p>Notice that <span class="math">\((p_x, p_y, p_z)\)</span> are the covariance of <span class="math">\(\mathbf{p}\)</span> in
this special reference frame, and <span class="math">\((\mu_x, \mu_y, \mu_z)\)</span> are the covariance
of the direction vector <span class="math">\(\mathbf{\mu}\)</span> in this reference frame.
The remaining task is to find the value of <span class="math">\((p_x, p_y, p_z)\)</span> and
<span class="math">\((\mu_x, \mu_y, \mu_z)\)</span> from <span class="math">\((p_0, p_1, p_2)\)</span> and <span class="math">\((\mu_0, \mu_1, \mu_2)\)</span>.</p>
<p>Since <span class="math">\(\mathbf{p}\)</span> is in the x-z plane, we get <span class="math">\(p_y = 0\)</span> for free.
Therefore, the remaining two covariance can be expressed as:</p>
<div class="math">
\[\begin{split}p_z = \mathbf{p} \cdot \mathbf\epsilon = \sum_{i=0}^2 p_i\epsilon_i \\
p_x = \sqrt{|\mathbf{p}|^2 - p_z^2}\end{split}\]</div>
<p>Notice that all the values on the left-hand are all in the special reference
frame whereas the values on the right-hand are in the general/global reference
frame.</p>
<p>Another thing worth mentioning here is that the expression above is assuming the
special reference frame and the original reference frame share the same origin,
which is true in most cases in mantid.
However, if they are not the same, we need to take into consideration of the
rigid-body shift due to change of origin, which can be easily done by:</p>
<div class="math">
\[p_i = p_i - o_i\]</div>
<p>where <span class="math">\(o_i\)</span> is the covariance of the new origin in the general reference
frame.</p>
<p>As for the covariances of the direction vector, the z component is relatively
easy,</p>
<div class="math">
\[\mu_z = \mathbf{\mu} \cdot \mathbf\epsilon = \sum_{i=0}^2 \mu_i\epsilon_i\]</div>
<p>Finding the x component takes a little bit extra efforts.
The x-axis of the special reference frame can be expressed as a unit vector:</p>
<div class="math">
\[\hat{\mathbf{x}} = \dfrac{1}{p_x} (\mathbf{p} - p_z \mathbf\epsilon)\]</div>
<p>Therefore,</p>
<div class="math">
\[\mu_x = \mathbf{\mu} \cdot \hat{\mathbf{x}}\]</div>
<p>Since direction vector is a unit vector, we can easily find</p>
<div class="math">
\[\mu_y = \sqrt{1 - \mu_x^2 - \mu_z^2}\]</div>
<p>Now we can plug the line parameterization into the cylindrical surface equation
to get the interception by solving for <span class="math">\(\lambda\)</span>, which gives us</p>
<div class="math">
\[\begin{split}(p_x + \mu_x \lambda)^2 + (\mu_y \lambda)^2 &amp;= r^2 \\
\Rightarrow
p_x^2 + 2 p_x \mu_x \lambda + \mu_x^2 \lambda^2 + \mu_y^2 \lambda^2 &amp;= r^2 \\
\Rightarrow
(1 - \mu_z^2) \lambda^2 + 2 p_x \mu_x \lambda + p_x^2 - r^2 &amp;= 0\end{split}\]</div>
<p>For a standard quadratic equation, <span class="math">\(a_2x^2 + a_1x^1 + a_0x^0 = 0\)</span>, we have</p>
<div class="math">
\[a_2 = 1 - \mu_z^2 = 1 - (\sum_{i=0}^2 \mu_i\epsilon_i)^2\]</div>
<p>and</p>
<div class="math">
\[\begin{split}a_1 &amp;= 2 p_x \mu_x = 2 p_x (\mathbf{\mu} \cdot \hat{\mathbf{x}}) \\
    &amp;= 2 p_x (\mathbf{\mu} \cdot \dfrac{1}{p_x}(\mathbf{p} - p_z \mathbf\epsilon)) \\
    &amp;= 2 [\mathbf{\mu} \cdot (\mathbf{p} - p_z \mathbf\epsilon)] \\
    &amp;= 2 \sum_{i=0}^2 \mu_i (p_i - p_z \epsilon_i) \\
    &amp;= 2 (\sum_{i=0}^2 \mu_i p_i - p_z \sum_{i=0}^2 \mu_i \epsilon_i) \\
    &amp;= 2 (\sum_{i=0}^2 \mu_i p_i - \sum_{i=0}^2 p_i\epsilon_i \sum_{i=0}^2 \mu_i \epsilon_i)\end{split}\]</div>
<p>and</p>
<div class="math">
\[\begin{split}a_0 &amp;= p_x^2 - r^2 = |\mathbf{p}|^2 - p_z^2 - r^2 \\
    &amp;= (\sum_{i=0}^2 p_i p_i)^2 - (\sum_{i=0}^2 p_i\epsilon_i)^2 - r^2\end{split}\]</div>
<p><strong>Category</strong>: <a class="reference external" href="../api/python/mantid/api/categories/Concepts.html">Concepts</a></p>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
      <ul class="nav navbar-nav" style=" float: right;">
      
      
          
            
  <li>
    <a href="GeometryofPosition.html" title="Previous Chapter: Geometry of Position"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Geometry of Position</span>
    </a>
  </li>
  <li>
    <a href="HistogramData.html" title="Next Chapter: Transition to the HistogramData module"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Transition to... &raquo;</span>
    </a>
  </li>
          
       
          <li><a href="#">Back to top</a></li>
       </ul>
    <p>
    </p>
  </div>
</footer>
  </body>
</html>